<?xml version="1.0"?>
<DTS:Executable xmlns:DTS="www.microsoft.com/SqlServer/Dts"
  DTS:refId="Package"
  DTS:CreationDate="6/24/2022 12:37:58 PM"
  DTS:CreationName="Microsoft.Package"
  DTS:CreatorComputerName="TCG03267CDE"
  DTS:CreatorName="TCG\Harshad.Deshmukh"
  DTS:DTSID="{A1B28040-3F73-421E-903B-1B614F4CFA7D}"
  DTS:ExecutableType="Microsoft.Package"
  DTS:LastModifiedProductVersion="15.0.2000.170"
  DTS:LocaleID="2057"
  DTS:ObjectName="Dallas - Visit By Source"
  DTS:PackageType="5"
  DTS:VersionBuild="63"
  DTS:VersionGUID="{666860BF-6CBF-4147-8ED2-29D26F76187C}">
  <DTS:Property
    DTS:Name="PackageFormatVersion">8</DTS:Property>
  <DTS:ConnectionManagers>
    <DTS:ConnectionManager
      DTS:refId="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
      DTS:CreationName="OLEDB"
      DTS:DTSID="{394A1823-FD15-487A-91A2-F3EF3B7817BB}"
      DTS:ObjectName="DI-BILLING.OpsBilling">
      <DTS:ObjectData>
        <DTS:ConnectionManager
          DTS:ConnectRetryCount="1"
          DTS:ConnectRetryInterval="5"
          DTS:ConnectionString="Data Source=DI-BILLING;Initial Catalog=OpsBilling;Provider=SQLNCLI11.1;Integrated Security=SSPI;Auto Translate=False;" />
      </DTS:ObjectData>
    </DTS:ConnectionManager>
    <DTS:ConnectionManager
      DTS:refId="Package.ConnectionManagers[Flat File Connection Manager]"
      DTS:CreationName="FLATFILE"
      DTS:DTSID="{9A3DA5D6-DB31-407D-96FD-19A147EB2CFE}"
      DTS:ObjectName="Flat File Connection Manager">
      <DTS:ObjectData>
        <DTS:ConnectionManager
          DTS:Format="Delimited"
          DTS:LocaleID="2057"
          DTS:HeaderRowDelimiter="_x000D__x000A_"
          DTS:ColumnNamesInFirstDataRow="True"
          DTS:RowDelimiter=""
          DTS:TextQualifier="_x003C_none_x003E_"
          DTS:CodePage="1252"
          DTS:ConnectionString="\\clbnas01\OpsDataTeam\8. Team\Harshad\Ops Automation\Dallas\Dallas Source Code List.csv">
          <DTS:FlatFileColumns>
            <DTS:FlatFileColumn
              DTS:ColumnType="Delimited"
              DTS:ColumnDelimiter="_x002C_"
              DTS:MaximumWidth="50"
              DTS:DataType="129"
              DTS:TextQualified="True"
              DTS:ObjectName="Type"
              DTS:DTSID="{B1E49D9A-C38F-4D3A-93D4-1465892A4E5E}"
              DTS:CreationName="" />
            <DTS:FlatFileColumn
              DTS:ColumnType="Delimited"
              DTS:ColumnDelimiter="_x002C_"
              DTS:MaximumWidth="50"
              DTS:DataType="129"
              DTS:TextQualified="True"
              DTS:ObjectName="Source Code"
              DTS:DTSID="{8182134E-58A4-4E00-8C25-217D5E5CE02A}"
              DTS:CreationName="" />
            <DTS:FlatFileColumn
              DTS:ColumnType="Delimited"
              DTS:ColumnDelimiter="_x000D__x000A_"
              DTS:MaximumWidth="50"
              DTS:DataType="129"
              DTS:TextQualified="True"
              DTS:ObjectName="Bin Length"
              DTS:DTSID="{D861516E-2D29-47C9-BDB0-37083A48D825}"
              DTS:CreationName="" />
          </DTS:FlatFileColumns>
        </DTS:ConnectionManager>
      </DTS:ObjectData>
    </DTS:ConnectionManager>
    <DTS:ConnectionManager
      DTS:refId="Package.ConnectionManagers[PPass]"
      DTS:CreationName="OLEDB"
      DTS:DelayValidation="True"
      DTS:DTSID="{DE205D8A-DF9F-410E-A52B-2F655746C1BF}"
      DTS:ObjectName="PPass">
      <DTS:ObjectData>
        <DTS:ConnectionManager
          DTS:Retain="True"
          DTS:ConnectRetryCount="1"
          DTS:ConnectRetryInterval="5"
          DTS:ConnectionString="Data Source=10.204.200.67;User ID=OPSBI_ETL;Initial Catalog=PPass;Provider=SQLNCLI11.1;Persist Security Info=True;Auto Translate=False;">
          <DTS:Password
            DTS:Name="Password"
            Sensitive="1"
            Encrypted="1">AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAwhmqfWwFw06Wdr3kWIU4/wAAAAAIAAAARABUAFMAAAADZgAAwAAAABAAAACcg3E0YeUd5t7DBcnuWf06AAAAAASAAACgAAAAEAAAAPc2L1bC71FxbmyUHcLb8ZYgAAAA5W9x7A/yRAn8FPawf932Pz7FQrqD3Ii+4AJ4Z/TuxMAUAAAA+DEmt3jwIODcbCz165A4Pfy0zwg</DTS:Password>
        </DTS:ConnectionManager>
      </DTS:ObjectData>
    </DTS:ConnectionManager>
  </DTS:ConnectionManagers>
  <DTS:Variables>
    <DTS:Variable
      DTS:CreationName=""
      DTS:DTSID="{E94B5B17-E4A1-4307-89E2-E5DBFF977809}"
      DTS:EvaluateAsExpression="True"
      DTS:Expression="UPPER( @[$Project::strUseReportMonth])   == &quot;Y&quot; ?   (DT_DATE)(DT_DBDATE)DATEADD(&quot;D&quot;,-(DAY(DATEADD(&quot;M&quot;,1,@[$Project::dtReportMonth]))),DATEADD(&quot;M&quot;,1,@[$Project::dtReportMonth])): (DT_DATE)(DT_DBDATE)DATEADD(&quot;D&quot;,-(DAY(DATEADD(&quot;M&quot;,1,Dateadd(&quot;M&quot;,-1 ,getdate())))),DATEADD(&quot;M&quot;,1,Dateadd(&quot;M&quot;,-1 ,getdate())))"
      DTS:IncludeInDebugDump="2345"
      DTS:Namespace="User"
      DTS:ObjectName="dtEndDate">
      <DTS:VariableValue
        DTS:DataType="7">12/31/2022</DTS:VariableValue>
    </DTS:Variable>
    <DTS:Variable
      DTS:CreationName=""
      DTS:DTSID="{A9EC7299-8BA5-4D2B-9AE0-7C5515D1408B}"
      DTS:EvaluateAsExpression="True"
      DTS:Expression="UPPER( @[$Project::strUseReportMonth])   == &quot;Y&quot; ?   (DT_DATE)(DT_DBDATE)Dateadd(&quot;D&quot;,-1*Day( @[$Project::dtReportMonth] ) +1,    @[$Project::dtReportMonth]): (DT_DATE)(DT_DBDATE) Dateadd(&quot;D&quot;,-1*Day(Dateadd(&quot;M&quot;,-1 ,getdate())) +1  ,Dateadd(&quot;M&quot;,-1 ,getdate()))"
      DTS:IncludeInDebugDump="2345"
      DTS:Namespace="User"
      DTS:ObjectName="dtReportMonth">
      <DTS:VariableValue
        DTS:DataType="7">12/1/2022</DTS:VariableValue>
    </DTS:Variable>
    <DTS:Variable
      DTS:CreationName=""
      DTS:DTSID="{6D09FEA5-5C5B-43F4-8FD5-B39DFB6BF1D2}"
      DTS:EvaluateAsExpression="True"
      DTS:Expression="UPPER( @[$Project::strUseReportMonth])   == &quot;Y&quot; ?   (DT_DATE)(DT_DBDATE)Dateadd(&quot;D&quot;,-1*Day( @[$Project::dtReportMonth] ) +1,    @[$Project::dtReportMonth]): (DT_DATE)(DT_DBDATE) Dateadd(&quot;D&quot;,-1*Day(Dateadd(&quot;M&quot;,-1 ,getdate())) +1  ,Dateadd(&quot;M&quot;,-1 ,getdate()))"
      DTS:IncludeInDebugDump="2345"
      DTS:Namespace="User"
      DTS:ObjectName="dtStartDate">
      <DTS:VariableValue
        DTS:DataType="7">12/1/2022</DTS:VariableValue>
    </DTS:Variable>
    <DTS:Variable
      DTS:CreationName=""
      DTS:DTSID="{CDAD262F-613D-436B-8760-83D01B1EC76B}"
      DTS:EvaluateAsExpression="True"
      DTS:Expression="&quot;DECLARE @StartDate VARCHAR(10)=&quot;+ &quot;'&quot;+(DT_WSTR, 10) @[User::dtStartDate] +&quot;'&quot;+ &quot;&#xA;DECLARE @EndDate VARCHAR(10)=&quot;+ &quot;'&quot;+(DT_WSTR, 10) @[User::dtEndDate] +&quot;'&quot;+ &quot;&#xA;&#xA;DECLARE @var_startDate VARCHAR(10)&#xA;SET @var_startDate=CONVERT(CHAR(8),CONVERT(date,@StartDate,103),112)&#xA;DECLARE @var_endDate VARCHAR(10)&#xA;SET @var_endDate=CONVERT(CHAR(8),CONVERT(date,@EndDate,103),112)&#xA;&#xA;&#xA;IF OBJECT_ID('tempdb..##temptable') IS NOT NULL&#xA;&#x9;DROP TABLE ##temptable&#xA;&#xA;CREATE TABLE ##temptable (&#xA;&#x9;&#x9;source_code &#x9;&#x9;varchar(20),&#xA;&#x9;&#x9;consumer_no &#x9;&#x9;INT NOT NULL,&#xA;&#x9;&#x9;external_identifier BIGINT NULL,&#xA;&#x9;&#x9;membership_no &#x9;&#x9;BIGINT NULL,&#xA;&#x9;&#x9;purchase_no &#x9;&#x9;INT NOT NULL,&#xA;&#x9;&#x9;track_seq &#x9;&#x9;&#x9;INT NOT NULL,&#xA;&#x9;&#x9;title &#x9;&#x9;&#x9;&#x9;varchar(20),&#xA;&#x9;&#x9;forename &#x9;&#x9;&#x9;varchar(50),&#xA;&#x9;&#x9;surname &#x9;&#x9;&#x9;varchar(50),&#xA;&#x9;&#x9;fullname &#x9;&#x9;&#x9;varchar(120),&#xA;&#x9;&#x9;source_desc &#x9;&#x9;varchar(255),&#xA;&#x9;&#x9;product_version &#x9;varchar(20),&#xA;&#x9;&#x9;paid_to_date &#x9;&#x9;date,&#xA;&#x9;&#x9;subs_issue_date &#x9;date,&#xA;&#x9;&#x9;subs_status &#x9;&#x9;varchar(5),&#xA;&#x9;&#x9;track_start &#x9;&#x9;date,&#xA;&#x9;&#x9;track_guests &#x9;&#x9;INT,&#xA;&#x9;&#x9;track_from &#x9;&#x9;&#x9;varchar(20),&#xA;&#x9;&#x9;track_value &#x9;&#x9;FLOAT,&#xA;&#x9;&#x9;creation_date &#x9;&#x9;date,&#xA;&#x9;&#x9;lounge_name&#x9;&#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;airport &#x9;&#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;trans_ccard_number &#x9;varchar(100),&#xA;&#x9;&#x9;external_ref &#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;track_batch &#x9;&#x9;INT,&#xA;&#x9;&#x9;old_system_ref &#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;campaign_code &#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;lounge_code&#x9;&#x9;&#x9;varchar(20),&#xA;&#x9;&#x9;city &#x9;&#x9;&#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;country &#x9;&#x9;&#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;vendor_tracking_code &#x9;varchar(100),&#xA;&#x9;&#x9;user_invitation_code &#x9;varchar(100),&#xA;&#x9;&#x9;remaining_mem_cli_count int,&#xA;&#x9;&#x9;remaining_mem_cli2_count int,&#xA;&#x9;&#x9;remaining_mem_pp_count &#x9;int,&#xA;&#x9;&#x9;remaining_gue_cli_count int,&#xA;&#x9;&#x9;remaining_gue_cli2_count int,&#xA;&#x9;&#x9;remaining_gue_pp_count &#x9;int,&#xA;&#x9;&#x9;remaining_mgu_cli_count int,&#xA;&#x9;&#x9;remaining_mgu_cli2_count int,&#xA;&#x9;&#x9;remaining_mgu_pp_count &#x9;int,&#xA;&#x9;&#x9;remaining_mgu_comp_count int,&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;experience_category &#x9;varchar(100),&#xA;&#x9;&#x9;experience_type &#x9;&#x9;varchar(100),&#xA;&#x9;&#x9;airport_terminal_name  varchar(100),&#xA;&#x9;&#x9;airport_terminal_type  varchar(100),&#xA;&#x9;&#x9;visit_type_id SMALLINT,&#xA;&#x9;&#x9;visit_type&#x9;INT,&#xA;&#x9;&#x9;ccard_type VARCHAR(100),&#xA;&#x9;&#x9;effective_date DATETIME2,&#xA;&#x9;&#x9;report_month date&#xA;&#xA;);&#xA;&#xA;&#xA;INSERT INTO ##temptable(&#x9;&#xA;&#x9;source_code,&#xA;&#x9;consumer_no,&#xA;&#x9;external_identifier,&#xA;&#x9;membership_no,&#xA;&#x9;purchase_no,&#xA;&#x9;track_seq,&#xA;&#x9;title,&#xA;&#x9;forename,&#xA;&#x9;surname,&#xA;&#x9;fullname,&#xA;&#x9;source_desc,&#xA;&#x9;product_version,&#xA;&#x9;paid_to_date,&#xA;&#x9;subs_issue_date,&#xA;&#x9;subs_status,&#xA;&#x9;track_start,&#xA;&#x9;track_guests,&#xA;&#x9;track_from,&#xA;&#x9;track_value,&#xA;&#x9;creation_date,&#xA;&#x9;lounge_name,&#xA;&#x9;airport,&#xA;&#x9;trans_ccard_number,&#xA;&#x9;external_ref,&#xA;&#x9;track_batch,&#xA;&#x9;old_system_ref,&#xA;&#x9;campaign_code,&#xA;&#x9;lounge_code,&#xA;&#x9;city,&#xA;&#x9;country,&#xA;&#x9;vendor_tracking_code,&#xA;&#x9;user_invitation_code,&#xA;&#x9;remaining_mem_cli_count,&#xA;&#x9;remaining_mem_cli2_count,&#xA;&#x9;remaining_mem_pp_count,&#xA;&#x9;remaining_gue_cli_count,&#xA;&#x9;remaining_gue_cli2_count,&#xA;&#x9;remaining_gue_pp_count,&#xA;&#x9;remaining_mgu_cli_count,&#xA;&#x9;remaining_mgu_cli2_count,&#xA;&#x9;remaining_mgu_pp_count,&#xA;&#x9;remaining_mgu_comp_count,&#xA;&#x9;&#xA;&#x9;experience_category,&#xA;&#x9;experience_type,&#xA;&#x9;airport_terminal_name,&#xA;&#x9;airport_terminal_type,&#xA;&#x9;visit_type_id,&#xA;&#x9;ccard_type, &#xA;&#x9;effective_date,&#xA;&#x9;report_month&#xA;&#xA;&#x9; )&#xA;SELECT&#x9;s.source_code,&#xA;&#x9;&#x9;c.consumer_no,&#xA;&#x9;&#x9;c.external_identifier,&#xA;&#x9;&#x9;c.membership_no,&#xA;&#x9;&#x9;p.purchase_no,&#xA;&#x9;&#x9;t.track_seq,&#xA;&#x9;&#x9;c.title,&#xA;&#x9;&#x9;c.forename,&#xA;&#x9;&#x9;c.surname,&#xA;&#x9;&#x9;LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(c.forename + ' ' + c.surname,' ',' |'),'| ',''),'|',''))) AS fullname,&#xA;&#x9;&#x9;s.source_desc,&#xA;&#x9;&#x9;p.product_version,&#xA;&#x9;&#x9;p.paid_to_date,&#xA;&#x9;&#x9;p.subs_issue_date,&#xA;&#x9;&#x9;p.subs_status,&#xA;&#x9;&#x9;t.track_start,&#xA;&#x9;&#x9;t.track_guests,&#xA;&#x9;&#x9;t.track_from,&#xA;&#x9;&#x9;t.track_value,&#xA;&#x9;&#x9;t.creation_date,&#xA;&#x9;&#x9;l.lounge_name,&#xA;&#x9;&#x9;a.pp_short_name AS airport,&#xA;&#x9;&#x9;p.trans_ccard_number,&#xA;&#x9;&#x9;t.external_ref,&#xA;&#x9;&#x9;t.track_batch,&#xA;&#x9;&#x9;p.old_system_ref,&#xA;&#x9;&#x9;s.campaign_code,&#xA;&#x9;&#x9;l.lounge_code,&#xA;&#x9;&#x9;a.airport_city AS city,&#xA;&#x9;&#x9;cou.code_desc AS country,&#xA;&#x9;&#x9;siv.vendor_tracking_code,&#xA;&#x9;&#x9;siv.user_invitation_code,&#xA;&#x9;&#x9;0 AS remaining_mem_cli_count,&#xA;&#x9;&#x9;0 AS remaining_mem_cli2_count,&#xA; &#x9;&#x9;0 AS remaining_mem_pp_count,&#xA; &#x9;&#x9;0 AS remaining_gue_cli_count,&#xA; &#x9;&#x9;0 AS remaining_gue_cli2_count,&#xA; &#x9;&#x9;0 AS remaining_gue_pp_count,&#xA; &#x9;&#x9;0 AS remaining_mgu_cli_count,&#xA; &#x9;&#x9;0 AS remaining_mgu_cli2_count,&#xA; &#x9;&#x9;0 AS remaining_mgu_pp_count,&#xA; &#x9;&#x9;0 AS remaining_mgu_comp_count,&#xA; &#x9;&#x9;&#xA;&#x9;&#x9;'Lounge' as experience_category,&#xA;&#x9;&#x9;'Lounge' as experience_type,&#xA;&#x9;&#x9;ate.terminal_name as airport_terminal_name,&#xA;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;WHEN l.lounge_type = 'I' THEN 'I'&#xA;&#x9;&#x9;&#x9;WHEN l.lounge_type = 'D' THEN 'D'&#xA;&#x9;&#x9;&#x9;ELSE 'U'&#xA;&#x9;&#x9;  END&#x9;as airport_terminal_type,&#xA;&#x9;&#x9;t.visit_type_id,&#xA;&#x9;&#x9;p.ccard_type,&#xA;&#x9;&#x9;p.effective_date,&#xA;&#x9;&#x9;CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, t.[creation_date]), 0) AS DATE)      AS &#x9;report_month&#xA;&#xA;--INTO ##temptable&#xA;FROM&#xA;&#x9;&#x9;PPass.dbo.source_deal_config AS sdc WITH (NOLOCK)&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.source AS s WITH (NOLOCK) ON sdc.source_code = s.source_code&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.source_subscription AS ss WITH (NOLOCK) ON sdc.source_deal_config_id = ss.source_deal_config_id&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_subscription_link AS psl WITH (NOLOCK) ON ss.source_subscription_id = psl.source_subscription_id&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.purchase AS p WITH (NOLOCK) ON psl.purchase_no = p.purchase_no&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.consumer AS c WITH (NOLOCK) ON p.consumer_no = c.consumer_no&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.tracking AS t WITH (NOLOCK) ON p.purchase_no = t.purchase_no&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.lounge AS l WITH (NOLOCK) ON l.lounge_code = t.track_from&#xA;&#x9;&#x9;INNER JOIN PPass.dbo.airport AS a WITH (NOLOCK) ON a.iso_airport_code = l.airport&#xA;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.airport_terminal AS ate WITH (NOLOCK) ON l.airport_terminal_id = ate.airport_terminal_id&#xA;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.code AS COU  WITH (NOLOCK) ON COU.code = l.country_code AND COU.codetype = 'CTRY'&#xA;&#x9;&#x9;&#xA;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_invitation_validation siv WITH (NOLOCK) ON siv.consumer_no = c.consumer_no&#xA;&#x9;WHERE&#xA;t.creation_date &gt;= @var_startDate AND t.creation_date &lt; DATEADD(d,1,@var_endDate)&#xA; AND t.track_status &lt;&gt; 'NA' &#xA;AND p.isDeleted = 0 &#xA;AND s.source_code in ( Select SourceCode from ##VisitBySourceSourceCodes)&#xA;--AND (p.consumer_no='1427229223' or c.membership_no='1427229223')&#xA;/* Load in the reedemed offers data */&#xA;&#xA;INSERT INTO ##temptable (&#x9;&#xA;&#x9;source_code,&#xA;&#x9;consumer_no,&#xA;&#x9;external_identifier,&#xA;&#x9;membership_no,&#xA;&#x9;purchase_no,&#xA;&#x9;track_seq,&#xA;&#x9;title,&#xA;&#x9;forename,&#xA;&#x9;surname,&#xA;&#x9;fullname,&#xA;&#x9;source_desc,&#xA;&#x9;product_version,&#xA;&#x9;paid_to_date,&#xA;&#x9;subs_issue_date,&#xA;&#x9;subs_status,&#xA;&#x9;track_start,&#xA;&#x9;track_guests,&#xA;&#x9;track_from,&#xA;&#x9;track_value,&#xA;&#x9;creation_date,&#xA;&#x9;lounge_name,&#xA;&#x9;airport,&#xA;&#x9;trans_ccard_number,&#xA;&#x9;external_ref,&#xA;&#x9;track_batch,&#xA;&#x9;old_system_ref,&#xA;&#x9;campaign_code,&#xA;&#x9;lounge_code,&#xA;&#x9;city,&#xA;&#x9;country,&#xA;&#x9;vendor_tracking_code,&#xA;&#x9;user_invitation_code,&#xA;&#x9;remaining_mem_cli_count,&#xA;&#x9;remaining_mem_cli2_count,&#xA;&#x9;remaining_mem_pp_count,&#xA;&#x9;remaining_gue_cli_count,&#xA;&#x9;remaining_gue_cli2_count,&#xA;&#x9;remaining_gue_pp_count,&#xA;&#x9;remaining_mgu_cli_count,&#xA;&#x9;remaining_mgu_cli2_count,&#xA;&#x9;remaining_mgu_pp_count,&#xA;&#x9;remaining_mgu_comp_count,&#xA;&#x9;experience_category,&#xA;&#x9;experience_type,&#xA;&#x9;airport_terminal_name,&#xA;&#x9;airport_terminal_type,&#xA;&#x9;visit_type_id,&#xA;&#x9;report_month&#xA;&#xA;&#x9; )&#xA;SELECT&#xA;&#x9;s.source_code,&#xA;&#x9;c.consumer_no,&#xA;&#x9;c.external_identifier,&#xA;&#x9;c.membership_no,&#xA;&#x9;p.purchase_no,&#xA;&#x9;t.track_seq,&#xA;&#x9;c.title,&#xA;&#x9;c.forename,&#xA;&#x9;c.surname,&#xA;&#x9;LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(c.forename + ' ' + c.surname,' ',' |'),'| ',''),'|',''))) AS fullname,&#xA;&#x9;s.source_desc,&#xA;&#x9;p.product_version,&#xA;&#x9;p.paid_to_date,&#xA;&#x9;p.subs_issue_date,&#xA;&#x9;p.subs_status,&#xA;&#x9;t.track_start,&#xA;&#x9;t.track_guests,&#xA;&#x9;t.track_from,&#xA;&#x9;t.track_value,&#xA;&#x9;t.creation_date,&#xA;&#x9;ord.outlet_name as lounge_name,&#xA;&#x9;a.pp_short_name AS airport,&#xA;&#x9;p.trans_ccard_number,&#xA;&#x9;t.external_ref,&#xA;&#x9;t.track_batch,&#xA;&#x9;p.old_system_ref,&#xA;&#x9;s.campaign_code,&#xA;&#x9;t.track_from as lounge_code,&#xA;&#x9;a.airport_city AS city,&#xA;&#x9;cou.code_desc AS country,&#xA;&#x9;siv.vendor_tracking_code,&#xA;&#x9;siv.user_invitation_code,&#xA;&#x9;0 AS remaining_mem_cli_count , &#xA;&#x9;0 AS remaining_mem_cli2_count , &#xA;&#x9;0 AS remaining_mem_pp_count , &#xA;&#x9;0 AS remaining_gue_cli_count , &#xA;&#x9;0 AS remaining_gue_cli2_count , &#xA;&#x9;0 AS remaining_gue_pp_count , &#xA;&#x9;0 AS remaining_mgu_cli_count , &#xA;&#x9;0 AS remaining_mgu_cli2_count , &#xA;&#x9;0 AS remaining_mgu_pp_count , &#xA;&#x9;0 AS remaining_mgu_comp_count,&#xA;&#x9;&#xA;&#x9;ord.offer_category as experience_category,&#xA;&#x9;&#x9;ord.offer_type as experience_type,&#xA;&#x9;ISNULL(ate.terminal_name, 'Unknown' ) as airport_terminal_name,&#xA;&#x9;'U' as airport_terminal_type,&#xA;&#x9;t.visit_type_id,&#xA;&#x9;CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, t.[creation_date]), 0) AS DATE)      AS &#x9;report_month&#xA;FROM&#xA;&#x9;PPass.dbo.source_deal_config AS sdc WITH (NOLOCK)&#xA;&#x9;INNER JOIN PPass.dbo.source AS s WITH (NOLOCK) ON sdc.source_code = s.source_code&#xA;&#x9;INNER JOIN PPass.dbo.source_subscription AS ss WITH (NOLOCK) ON sdc.source_deal_config_id = ss.source_deal_config_id&#xA;&#x9;INNER JOIN PPass.dbo.purchase_subscription_link AS psl WITH (NOLOCK) ON ss.source_subscription_id = psl.source_subscription_id&#xA;&#x9;INNER JOIN PPass.dbo.purchase AS p WITH (NOLOCK) ON psl.purchase_no = p.purchase_no&#xA;&#x9;INNER JOIN PPass.dbo.consumer AS c WITH (NOLOCK) ON p.consumer_no = c.consumer_no&#xA;&#x9;INNER JOIN PPass.dbo.tracking AS t WITH (NOLOCK) ON p.purchase_no = t.purchase_no&#xA;&#x9;INNER JOIN PPass.dbo.offer_redemption_details AS ord WITH (NOLOCK) ON ord.consumer_no = c.consumer_no AND ord.track_seq = t.track_seq&#xA;&#x9;INNER JOIN PPass.dbo.airport AS a WITH (NOLOCK) ON a.iso_airport_code = ord.airport_iso_code&#xA;&#x9;LEFT JOIN PPass.dbo.outlet_airport_terminal AS oat WITH (NOLOCK) ON ord.outlet_id = oat.outlet_id&#xA;&#x9;LEFT JOIN PPass.dbo.airport_terminal AS ate WITH (NOLOCK) ON oat.airport_terminal_id = ate.airport_terminal_id&#xA;&#x9;LEFT OUTER JOIN PPass.dbo.code AS COU WITH (NOLOCK) ON cou.alpha_1 = a.iso_country_code&#xA;&#x9;&#x9;AND cou.codetype = 'CTRY2'&#xA;&#x9;&#x9;AND cou.alpha_5 &lt;&gt; ''&#xA;&#x9;LEFT OUTER JOIN PPass.dbo.source_invitation_validation siv WITH (NOLOCK) ON siv.consumer_no = c.consumer_no&#xA;&#x9;&#xA;WHERE&#xA;t.creation_date &gt;= @var_startDate AND t.creation_date &lt; DATEADD(d,1,@var_endDate)&#xA; AND t.track_status &lt;&gt; 'NA' &#xA;AND p.isDeleted = 0 &#xA;AND s.source_code in (Select SourceCode from ##VisitBySourceSourceCodes)&#xA;--AND (p.consumer_no='1427229223' or c.membership_no='1427229223')&#xA;/* update the temp table with an index */&#xA;--ALTER TABLE ##temptable &#xA;--ADD CONSTRAINT PK_##temptable &#xA;--PRIMARY KEY NONCLUSTERED (purchase_no, track_seq)&#xA;--&#x9;&#x9;&#x9;CREATE NONCLUSTERED INDEX ##temptable_idx1 ON ##temptable (source_code, consumer_no, fullname, track_start, lounge_name, external_ref) &#xA;--&#x9;&#x9;&#x9;WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]&#xA;&#xA;--Select * from ##temptable&#xA;&#xA;&#x9;&#x9;/*  MEM PPAYVISIT  */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;           &#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no;&#xA;&#xA;&#x9;/* MEM CPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable ##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no;&#xA;&#xA;&#x9;&#x9;&#x9;&#x9;/* MEM CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;&#x9;&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* GUE PPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* GUE CPAYLIST */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* GUE CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/*MGU PPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;/* MGU CPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* MGU CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* SHAREDMEM PPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* SHAREDMEM CPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;/* SHAREDMEM CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 8&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* SHAREDGUE PPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* SHAREDGUE CPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#xA;/* SHAREDGUE CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 9&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;/* SHAREDMGU PPAYVISIT */&#xA;&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;/* SHAREDMGU CPAYVISIT */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;/*SHAREDMGU CPAYVISIT2 */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 10&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;/*OFFERMEM PPAYVISIT */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERMEMCPAYLIST */&#xA;&#x9;&#x9;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERMEMCPAYLIST2 */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 6&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERGUEPPAYLIST */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERGUECPAYLIST */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERGUECPAYLIST2 */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 5&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERMGUPPAYLIST */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 21&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_PP_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERMGUCPAYLIST */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 22&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;/* OFFERMGUCPAYLIST2 */&#xA;;WITH used_visit_allocations AS (&#xA;            &#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;COUNT(1) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase_visit_allocation_his AS pvah2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;EXISTS (&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;##temptable temp2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;temp2.purchase_no = pval2.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pvah2.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva2.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND salg.guest_source_visit_allocation_id is NULL&#xA;&#x9;&#x9;&#x9;&#x9;GROUP BY&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pvah2.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;derived_visit_allocation AS (&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_from,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_count_to,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pva.visit_validity_type_id,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN pva.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(pva.visit_count_to - pva.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE (pva.visit_count_to - pva.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS allocated_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;PPass.dbo.purchase pur&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.charge_owner_id = 25&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visitor_type_id = 7&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.visit_allocation_type_id NOT IN (3,4)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;AND pur.isDeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id&#xA;               &#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(&#x9;pva.valid_from &lt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;AND pva.valid_to &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;OR pva.visit_validity_type_id = 2&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;)&#xA;&#x9;&#x9;&#x9;),&#xA;&#x9;&#x9;&#x9;calculated_visit_allocation AS&#xA;&#x9;&#x9;&#x9;(&#xA;&#x9;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;CASE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_to = 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN 9999&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;WHEN derived_visit_allocation.visit_count_from = 0&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;THEN&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;ELSE&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;&#x9;END&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;END AS visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.used_visit_count AS used_visit_number,&#xA;&#x9;&#x9;&#x9;&#x9;&#x9;derived_visit_allocation.purchase_no&#xA;&#x9;&#x9;&#x9;&#x9;FROM derived_visit_allocation&#xA;&#x9;&#x9;&#x9;)&#xA;&#xA;&#x9;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;&#x9;remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no&#xA;&#x9;&#x9;;WITH derived_credit_data AS (&#xA;&#x9;&#x9;&#x9;SELECT&#xA;&#x9;&#x9;&#x9;&#x9;ISNULL(SUM(CASE WHEN vch.purchase_visit_allocation_his_id IS NULL THEN 1 ELSE 0 END),0) AS unused_visit,&#xA;&#x9;&#x9;&#x9;&#x9;ISNULL(SUM(CASE WHEN vch.purchase_visit_allocation_his_id IS NOT NULL THEN 1 ELSE 0 END),0) AS used_visit,&#xA;&#x9;&#x9;&#x9;&#x9;pval.purchase_no&#xA;&#x9;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;&#x9;PPass.dbo.visit_credit_his AS vch&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.visit_credit AS vc ON vch.visit_credit_id = vc.visit_credit_id&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.visit_credit_purchase_allocation AS vcpa ON vch.visit_credit_his_id = vcpa.visit_credit_his_id&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation AS pva ON vcpa.purchase_visit_allocation_id = pva.purchase_visit_allocation_id&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_grp AS pvag ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;&#x9;INNER JOIN PPass.dbo.purchase_visit_allocation_link AS pval ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id&#xA;&#x9;&#x9;&#x9;WHERE&#xA;&#x9;&#x9;&#x9;&#x9;vch.isdeleted = 0&#xA;&#x9;&#x9;&#x9;&#x9;AND vch.expiry_date &gt;= getdate()&#xA;&#x9;&#x9;&#x9;&#x9;AND vc.visit_credit_type_id = 1&#xA;&#x9;&#x9;&#x9;&#x9;AND vc.visitor_type_id = 3&#xA;&#x9;&#x9;&#x9;GROUP BY pval.purchase_no&#xA;&#x9;&#x9;)&#xA;&#x9;&#x9;UPDATE&#xA;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;SET&#xA;&#x9;&#x9;&#x9;REMAINING_MGU_COMP_COUNT = derived_credit_data.unused_visit&#xA;&#x9;&#x9;FROM&#xA;&#x9;&#x9;&#x9;##temptable&#xA;&#x9;&#x9;&#x9;INNER JOIN derived_credit_data ON ##temptable.purchase_no = derived_credit_data.purchase_no&#xA;&#xA;&#xA;&quot;"
      DTS:IncludeInDebugDump="2345"
      DTS:Namespace="User"
      DTS:ObjectName="strQuery">
      <DTS:VariableValue
        DTS:DataType="8">DECLARE @StartDate VARCHAR(10)='01/12/2022'
DECLARE @EndDate VARCHAR(10)='31/12/2022'

DECLARE @var_startDate VARCHAR(10)
SET @var_startDate=CONVERT(CHAR(8),CONVERT(date,@StartDate,103),112)
DECLARE @var_endDate VARCHAR(10)
SET @var_endDate=CONVERT(CHAR(8),CONVERT(date,@EndDate,103),112)


IF OBJECT_ID('tempdb..##temptable') IS NOT NULL
	DROP TABLE ##temptable

CREATE TABLE ##temptable (
		source_code 		varchar(20),
		consumer_no 		INT NOT NULL,
		external_identifier BIGINT NULL,
		membership_no 		BIGINT NULL,
		purchase_no 		INT NOT NULL,
		track_seq 			INT NOT NULL,
		title 				varchar(20),
		forename 			varchar(50),
		surname 			varchar(50),
		fullname 			varchar(120),
		source_desc 		varchar(255),
		product_version 	varchar(20),
		paid_to_date 		date,
		subs_issue_date 	date,
		subs_status 		varchar(5),
		track_start 		date,
		track_guests 		INT,
		track_from 			varchar(20),
		track_value 		FLOAT,
		creation_date 		date,
		lounge_name			varchar(100),
		airport 			varchar(100),
		trans_ccard_number 	varchar(100),
		external_ref 		varchar(100),
		track_batch 		INT,
		old_system_ref 		varchar(100),
		campaign_code 		varchar(100),
		lounge_code			varchar(20),
		city 				varchar(100),
		country 				varchar(100),
		vendor_tracking_code 	varchar(100),
		user_invitation_code 	varchar(100),
		remaining_mem_cli_count int,
		remaining_mem_cli2_count int,
		remaining_mem_pp_count 	int,
		remaining_gue_cli_count int,
		remaining_gue_cli2_count int,
		remaining_gue_pp_count 	int,
		remaining_mgu_cli_count int,
		remaining_mgu_cli2_count int,
		remaining_mgu_pp_count 	int,
		remaining_mgu_comp_count int,
		
		experience_category 	varchar(100),
		experience_type 		varchar(100),
		airport_terminal_name  varchar(100),
		airport_terminal_type  varchar(100),
		visit_type_id SMALLINT,
		visit_type	INT,
		ccard_type VARCHAR(100),
		effective_date DATETIME2,
		report_month date

);


INSERT INTO ##temptable(	
	source_code,
	consumer_no,
	external_identifier,
	membership_no,
	purchase_no,
	track_seq,
	title,
	forename,
	surname,
	fullname,
	source_desc,
	product_version,
	paid_to_date,
	subs_issue_date,
	subs_status,
	track_start,
	track_guests,
	track_from,
	track_value,
	creation_date,
	lounge_name,
	airport,
	trans_ccard_number,
	external_ref,
	track_batch,
	old_system_ref,
	campaign_code,
	lounge_code,
	city,
	country,
	vendor_tracking_code,
	user_invitation_code,
	remaining_mem_cli_count,
	remaining_mem_cli2_count,
	remaining_mem_pp_count,
	remaining_gue_cli_count,
	remaining_gue_cli2_count,
	remaining_gue_pp_count,
	remaining_mgu_cli_count,
	remaining_mgu_cli2_count,
	remaining_mgu_pp_count,
	remaining_mgu_comp_count,
	
	experience_category,
	experience_type,
	airport_terminal_name,
	airport_terminal_type,
	visit_type_id,
	ccard_type, 
	effective_date,
	report_month

	 )
SELECT	s.source_code,
		c.consumer_no,
		c.external_identifier,
		c.membership_no,
		p.purchase_no,
		t.track_seq,
		c.title,
		c.forename,
		c.surname,
		LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(c.forename + ' ' + c.surname,' ',' |'),'| ',''),'|',''))) AS fullname,
		s.source_desc,
		p.product_version,
		p.paid_to_date,
		p.subs_issue_date,
		p.subs_status,
		t.track_start,
		t.track_guests,
		t.track_from,
		t.track_value,
		t.creation_date,
		l.lounge_name,
		a.pp_short_name AS airport,
		p.trans_ccard_number,
		t.external_ref,
		t.track_batch,
		p.old_system_ref,
		s.campaign_code,
		l.lounge_code,
		a.airport_city AS city,
		cou.code_desc AS country,
		siv.vendor_tracking_code,
		siv.user_invitation_code,
		0 AS remaining_mem_cli_count,
		0 AS remaining_mem_cli2_count,
 		0 AS remaining_mem_pp_count,
 		0 AS remaining_gue_cli_count,
 		0 AS remaining_gue_cli2_count,
 		0 AS remaining_gue_pp_count,
 		0 AS remaining_mgu_cli_count,
 		0 AS remaining_mgu_cli2_count,
 		0 AS remaining_mgu_pp_count,
 		0 AS remaining_mgu_comp_count,
 		
		'Lounge' as experience_category,
		'Lounge' as experience_type,
		ate.terminal_name as airport_terminal_name,
		CASE
			WHEN l.lounge_type = 'I' THEN 'I'
			WHEN l.lounge_type = 'D' THEN 'D'
			ELSE 'U'
		  END	as airport_terminal_type,
		t.visit_type_id,
		p.ccard_type,
		p.effective_date,
		CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, t.[creation_date]), 0) AS DATE)      AS 	report_month

--INTO ##temptable
FROM
		PPass.dbo.source_deal_config AS sdc WITH (NOLOCK)
		INNER JOIN PPass.dbo.source AS s WITH (NOLOCK) ON sdc.source_code = s.source_code
		INNER JOIN PPass.dbo.source_subscription AS ss WITH (NOLOCK) ON sdc.source_deal_config_id = ss.source_deal_config_id
		INNER JOIN PPass.dbo.purchase_subscription_link AS psl WITH (NOLOCK) ON ss.source_subscription_id = psl.source_subscription_id
		INNER JOIN PPass.dbo.purchase AS p WITH (NOLOCK) ON psl.purchase_no = p.purchase_no
		INNER JOIN PPass.dbo.consumer AS c WITH (NOLOCK) ON p.consumer_no = c.consumer_no
		INNER JOIN PPass.dbo.tracking AS t WITH (NOLOCK) ON p.purchase_no = t.purchase_no
		INNER JOIN PPass.dbo.lounge AS l WITH (NOLOCK) ON l.lounge_code = t.track_from
		INNER JOIN PPass.dbo.airport AS a WITH (NOLOCK) ON a.iso_airport_code = l.airport
		LEFT OUTER JOIN PPass.dbo.airport_terminal AS ate WITH (NOLOCK) ON l.airport_terminal_id = ate.airport_terminal_id
		LEFT OUTER JOIN PPass.dbo.code AS COU  WITH (NOLOCK) ON COU.code = l.country_code AND COU.codetype = 'CTRY'
		
		LEFT OUTER JOIN PPass.dbo.source_invitation_validation siv WITH (NOLOCK) ON siv.consumer_no = c.consumer_no
	WHERE
t.creation_date &gt;= @var_startDate AND t.creation_date &lt; DATEADD(d,1,@var_endDate)
 AND t.track_status &lt;&gt; 'NA' 
AND p.isDeleted = 0 
AND s.source_code in ( Select SourceCode from ##VisitBySourceSourceCodes)
--AND (p.consumer_no='1427229223' or c.membership_no='1427229223')
/* Load in the reedemed offers data */

INSERT INTO ##temptable (	
	source_code,
	consumer_no,
	external_identifier,
	membership_no,
	purchase_no,
	track_seq,
	title,
	forename,
	surname,
	fullname,
	source_desc,
	product_version,
	paid_to_date,
	subs_issue_date,
	subs_status,
	track_start,
	track_guests,
	track_from,
	track_value,
	creation_date,
	lounge_name,
	airport,
	trans_ccard_number,
	external_ref,
	track_batch,
	old_system_ref,
	campaign_code,
	lounge_code,
	city,
	country,
	vendor_tracking_code,
	user_invitation_code,
	remaining_mem_cli_count,
	remaining_mem_cli2_count,
	remaining_mem_pp_count,
	remaining_gue_cli_count,
	remaining_gue_cli2_count,
	remaining_gue_pp_count,
	remaining_mgu_cli_count,
	remaining_mgu_cli2_count,
	remaining_mgu_pp_count,
	remaining_mgu_comp_count,
	experience_category,
	experience_type,
	airport_terminal_name,
	airport_terminal_type,
	visit_type_id,
	report_month

	 )
SELECT
	s.source_code,
	c.consumer_no,
	c.external_identifier,
	c.membership_no,
	p.purchase_no,
	t.track_seq,
	c.title,
	c.forename,
	c.surname,
	LTRIM(RTRIM(REPLACE(REPLACE(REPLACE(c.forename + ' ' + c.surname,' ',' |'),'| ',''),'|',''))) AS fullname,
	s.source_desc,
	p.product_version,
	p.paid_to_date,
	p.subs_issue_date,
	p.subs_status,
	t.track_start,
	t.track_guests,
	t.track_from,
	t.track_value,
	t.creation_date,
	ord.outlet_name as lounge_name,
	a.pp_short_name AS airport,
	p.trans_ccard_number,
	t.external_ref,
	t.track_batch,
	p.old_system_ref,
	s.campaign_code,
	t.track_from as lounge_code,
	a.airport_city AS city,
	cou.code_desc AS country,
	siv.vendor_tracking_code,
	siv.user_invitation_code,
	0 AS remaining_mem_cli_count , 
	0 AS remaining_mem_cli2_count , 
	0 AS remaining_mem_pp_count , 
	0 AS remaining_gue_cli_count , 
	0 AS remaining_gue_cli2_count , 
	0 AS remaining_gue_pp_count , 
	0 AS remaining_mgu_cli_count , 
	0 AS remaining_mgu_cli2_count , 
	0 AS remaining_mgu_pp_count , 
	0 AS remaining_mgu_comp_count,
	
	ord.offer_category as experience_category,
		ord.offer_type as experience_type,
	ISNULL(ate.terminal_name, 'Unknown' ) as airport_terminal_name,
	'U' as airport_terminal_type,
	t.visit_type_id,
	CAST(DATEADD(MONTH, DATEDIFF(MONTH, 0, t.[creation_date]), 0) AS DATE)      AS 	report_month
FROM
	PPass.dbo.source_deal_config AS sdc WITH (NOLOCK)
	INNER JOIN PPass.dbo.source AS s WITH (NOLOCK) ON sdc.source_code = s.source_code
	INNER JOIN PPass.dbo.source_subscription AS ss WITH (NOLOCK) ON sdc.source_deal_config_id = ss.source_deal_config_id
	INNER JOIN PPass.dbo.purchase_subscription_link AS psl WITH (NOLOCK) ON ss.source_subscription_id = psl.source_subscription_id
	INNER JOIN PPass.dbo.purchase AS p WITH (NOLOCK) ON psl.purchase_no = p.purchase_no
	INNER JOIN PPass.dbo.consumer AS c WITH (NOLOCK) ON p.consumer_no = c.consumer_no
	INNER JOIN PPass.dbo.tracking AS t WITH (NOLOCK) ON p.purchase_no = t.purchase_no
	INNER JOIN PPass.dbo.offer_redemption_details AS ord WITH (NOLOCK) ON ord.consumer_no = c.consumer_no AND ord.track_seq = t.track_seq
	INNER JOIN PPass.dbo.airport AS a WITH (NOLOCK) ON a.iso_airport_code = ord.airport_iso_code
	LEFT JOIN PPass.dbo.outlet_airport_terminal AS oat WITH (NOLOCK) ON ord.outlet_id = oat.outlet_id
	LEFT JOIN PPass.dbo.airport_terminal AS ate WITH (NOLOCK) ON oat.airport_terminal_id = ate.airport_terminal_id
	LEFT OUTER JOIN PPass.dbo.code AS COU WITH (NOLOCK) ON cou.alpha_1 = a.iso_country_code
		AND cou.codetype = 'CTRY2'
		AND cou.alpha_5 &lt;&gt; ''
	LEFT OUTER JOIN PPass.dbo.source_invitation_validation siv WITH (NOLOCK) ON siv.consumer_no = c.consumer_no
	
WHERE
t.creation_date &gt;= @var_startDate AND t.creation_date &lt; DATEADD(d,1,@var_endDate)
 AND t.track_status &lt;&gt; 'NA' 
AND p.isDeleted = 0 
AND s.source_code in (Select SourceCode from ##VisitBySourceSourceCodes)
--AND (p.consumer_no='1427229223' or c.membership_no='1427229223')
/* update the temp table with an index */
--ALTER TABLE ##temptable 
--ADD CONSTRAINT PK_##temptable 
--PRIMARY KEY NONCLUSTERED (purchase_no, track_seq)
--			CREATE NONCLUSTERED INDEX ##temptable_idx1 ON ##temptable (source_code, consumer_no, fullname, track_start, lounge_name, external_ref) 
--			WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 100) ON [PRIMARY]

--Select * from ##temptable

		/*  MEM PPAYVISIT  */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 1
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
           
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 1
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_PP_count = calculated_visit_allocation.visit_number
				
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no;

	/* MEM CPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 1
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 1
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable ##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no;

				/* MEM CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 1
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 1
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number
				
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* GUE PPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 2
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 2
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* GUE CPAYLIST */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 2
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 2
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* GUE CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 2
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 2
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/*MGU PPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 3
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 3
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
/* MGU CPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 3
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 3
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* MGU CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 3
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 3
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* SHAREDMEM PPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 8
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 8
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* SHAREDMEM CPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 8
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 8
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
/* SHAREDMEM CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 8
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 8
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* SHAREDGUE PPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 9
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 9
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* SHAREDGUE CPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 9
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 9
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no

/* SHAREDGUE CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 9
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 9
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
/* SHAREDMGU PPAYVISIT */

		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 10
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 10
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
				/* SHAREDMGU CPAYVISIT */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 10
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 10
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
				/*SHAREDMGU CPAYVISIT2 */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 10
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 10
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
/*OFFERMEM PPAYVISIT */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 6
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 6
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERMEMCPAYLIST */
		;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 6
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 6
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERMEMCPAYLIST2 */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 6
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 6
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MEM_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERGUEPPAYLIST */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 5
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 5
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERGUECPAYLIST */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 5
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 5
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERGUECPAYLIST2 */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 5
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 5
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_GUE_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERMGUPPAYLIST */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 7
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 21
					AND pva.visitor_type_id = 7
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_PP_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERMGUCPAYLIST */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 7
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 22
					AND pva.visitor_type_id = 7
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		/* OFFERMGUCPAYLIST2 */
;WITH used_visit_allocations AS (
            	SELECT
					COUNT(1) AS used_visit_count,
					pvah2.purchase_visit_allocation_id
				FROM
					PPass.dbo.purchase_visit_allocation_his AS pvah2
					INNER JOIN PPass.dbo.purchase_visit_allocation pva2 ON pvah2.purchase_visit_allocation_id = pva2.purchase_visit_allocation_id
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval2 ON pva2.purchase_visit_allocation_grp_id = pval2.purchase_visit_allocation_grp_id
					LEFT OUTER JOIN PPass.dbo.source_visit_allocation_mem_gue_link salg ON pva2.source_visit_allocation_id = salg.guest_source_visit_allocation_id
				WHERE
						EXISTS (
							SELECT
								1
							FROM
								##temptable temp2
							WHERE
								temp2.purchase_no = pval2.purchase_no
						)
					AND pvah2.isdeleted = 0
					AND pva2.visitor_type_id = 7
					AND salg.guest_source_visit_allocation_id is NULL
				GROUP BY
					pvah2.purchase_visit_allocation_id
			),
			derived_visit_allocation AS (
				SELECT
					pva.visit_count_from,
					pva.visit_count_to,
					pva.visit_validity_type_id,
					CASE
						WHEN pva.visit_count_to = 9999
							THEN 9999
						WHEN pva.visit_count_from = 0
							THEN	(pva.visit_count_to - pva.visit_count_from)
						ELSE (pva.visit_count_to - pva.visit_count_from) + 1
					END AS allocated_visit_count,
					ISNULL(used_visit_allocations.used_visit_count, 0) AS used_visit_count,
					pur.purchase_no
				FROM
					PPass.dbo.purchase pur
					INNER JOIN PPass.dbo.purchase_visit_allocation_link pval ON pval.purchase_no = pur.purchase_no
					INNER JOIN PPass.dbo.purchase_visit_allocation_grp pvag ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
					INNER JOIN PPass.dbo.purchase_visit_allocation pva ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
					AND pva.charge_owner_id = 25
					AND pva.visitor_type_id = 7
					AND pva.visit_allocation_type_id NOT IN (3,4)
					AND pur.isDeleted = 0
					LEFT JOIN used_visit_allocations ON pva.purchase_visit_allocation_id = used_visit_allocations.purchase_visit_allocation_id
               	WHERE
						(
							(	pva.valid_from &lt;= getdate()
								AND pva.valid_to &gt;= getdate()
							)
							OR pva.visit_validity_type_id = 2
						)
			),
			calculated_visit_allocation AS
			(
				SELECT
					CASE WHEN derived_visit_allocation.visit_count_to = 9999 THEN
						9999
					ELSE
						CASE WHEN derived_visit_allocation.visit_validity_type_id = 2 THEN
							CASE
								WHEN derived_visit_allocation.visit_count_to = 9999
									THEN 9999
								WHEN derived_visit_allocation.visit_count_from = 0
									THEN	(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from)
								ELSE
									(derived_visit_allocation.visit_count_to - derived_visit_allocation.visit_count_from) + 1
							END
						ELSE
							(derived_visit_allocation.allocated_visit_count - derived_visit_allocation.used_visit_count)
						END
					END AS visit_number,
					derived_visit_allocation.used_visit_count AS used_visit_number,
					derived_visit_allocation.purchase_no
				FROM derived_visit_allocation
			)

			UPDATE
				##temptable
			SET
				remaining_MGU_CLI2_count = calculated_visit_allocation.visit_number
			FROM
				##temptable
				INNER JOIN calculated_visit_allocation ON ##temptable.purchase_no = calculated_visit_allocation.purchase_no
		;WITH derived_credit_data AS (
			SELECT
				ISNULL(SUM(CASE WHEN vch.purchase_visit_allocation_his_id IS NULL THEN 1 ELSE 0 END),0) AS unused_visit,
				ISNULL(SUM(CASE WHEN vch.purchase_visit_allocation_his_id IS NOT NULL THEN 1 ELSE 0 END),0) AS used_visit,
				pval.purchase_no
			FROM
				PPass.dbo.visit_credit_his AS vch
				INNER JOIN PPass.dbo.visit_credit AS vc ON vch.visit_credit_id = vc.visit_credit_id
				INNER JOIN PPass.dbo.visit_credit_purchase_allocation AS vcpa ON vch.visit_credit_his_id = vcpa.visit_credit_his_id
				INNER JOIN PPass.dbo.purchase_visit_allocation AS pva ON vcpa.purchase_visit_allocation_id = pva.purchase_visit_allocation_id
				INNER JOIN PPass.dbo.purchase_visit_allocation_grp AS pvag ON pva.purchase_visit_allocation_grp_id = pvag.purchase_visit_allocation_grp_id
				INNER JOIN PPass.dbo.purchase_visit_allocation_link AS pval ON pvag.purchase_visit_allocation_grp_id = pval.purchase_visit_allocation_grp_id
			WHERE
				vch.isdeleted = 0
				AND vch.expiry_date &gt;= getdate()
				AND vc.visit_credit_type_id = 1
				AND vc.visitor_type_id = 3
			GROUP BY pval.purchase_no
		)
		UPDATE
			##temptable
		SET
			REMAINING_MGU_COMP_COUNT = derived_credit_data.unused_visit
		FROM
			##temptable
			INNER JOIN derived_credit_data ON ##temptable.purchase_no = derived_credit_data.purchase_no


</DTS:VariableValue>
    </DTS:Variable>
  </DTS:Variables>
  <DTS:Executables>
    <DTS:Executable
      DTS:refId="Package\Data Flow Task"
      DTS:CreationName="Microsoft.Pipeline"
      DTS:DelayValidation="True"
      DTS:Description="Data Flow Task"
      DTS:DTSID="{43C92F2D-0018-40BD-8571-B7E33D980DB5}"
      DTS:ExecutableType="Microsoft.Pipeline"
      DTS:LocaleID="-1"
      DTS:ObjectName="Data Flow Task"
      DTS:TaskContact="Performs high-performance data extraction, transformation and loading;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1">
      <DTS:Variables />
      <DTS:ObjectData>
        <pipeline
          version="1">
          <components>
            <component
              refId="Package\Data Flow Task\OLE DB Destination"
              componentClassID="Microsoft.OLEDBDestination"
              contactInfo="OLE DB Destination;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;4"
              description="OLE DB Destination"
              name="OLE DB Destination"
              usesDispositions="true"
              version="4">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset">[dbo].[VisitBySourceSourceCodes]</property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor, Microsoft.DataTransformationServices.Controls, Version=15.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91">Select * from ##VisitBySourceSourceCodes</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">2</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the values supplied for identity columns will be copied to the destination. If false, values for identity columns will be auto-generated at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepIdentity">false</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the columns containing null will have null inserted in the destination. If false, columns containing null will have their default values inserted at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepNulls">false</property>
                <property
                  dataType="System.String"
                  description="Specifies options to be used with fast load.  Applies only if fast load is turned on."
                  name="FastLoadOptions">TABLOCK,CHECK_CONSTRAINTS</property>
                <property
                  dataType="System.Int32"
                  description="Specifies when commits are issued during data insertion.  A value of 0 specifies that one commit will be issued at the end of data insertion.  Applies only if fast load is turned on."
                  name="FastLoadMaxInsertCommitSize">2147483647</property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task\OLE DB Destination.Connections[OleDbConnection]"
                  connectionManagerID="Package.ConnectionManagers[PPass]"
                  connectionManagerRefId="Package.ConnectionManagers[PPass]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <inputs>
                <input
                  refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input]"
                  errorOrTruncationOperation="Insert"
                  errorRowDisposition="FailComponent"
                  hasSideEffects="true"
                  name="OLE DB Destination Input">
                  <inputColumns>
                    <inputColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Category]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="Category"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Category]"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[Category]" />
                    <inputColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[SourceCode]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="SourceCode"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[SourceCode]"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[SourceCode]" />
                    <inputColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[BinLength]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="10"
                      cachedName="BinLength"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[BinLength]"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[BinLength]" />
                  </inputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Category]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Category" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[SourceCode]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="SourceCode" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[BinLength]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="BinLength" />
                  </externalMetadataColumns>
                </input>
              </inputs>
              <outputs>
                <output
                  refId="Package\Data Flow Task\OLE DB Destination.Outputs[OLE DB Destination Error Output]"
                  exclusionGroup="1"
                  isErrorOut="true"
                  name="OLE DB Destination Error Output"
                  synchronousInputId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input]">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
            <component
              refId="Package\Data Flow Task\OLE DB Source"
              componentClassID="Microsoft.OLEDBSource"
              contactInfo="OLE DB Source;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;7"
              description="OLE DB Source"
              name="OLE DB Source"
              usesDispositions="true"
              version="7">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset"></property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor, Microsoft.DataTransformationServices.Controls, Version=15.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91">SELECT * FROM rprt.Dallas_SourceCodeList</property>
                <property
                  dataType="System.String"
                  description="The variable that contains the SQL command to be executed."
                  name="SqlCommandVariable"></property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">2</property>
                <property
                  dataType="System.String"
                  description="The mappings between the parameters in the SQL command and variables."
                  name="ParameterMapping"></property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task\OLE DB Source.Connections[OleDbConnection]"
                  connectionManagerID="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  connectionManagerRefId="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <outputs>
                <output
                  refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output]"
                  name="OLE DB Source Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[Category]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Category]"
                      length="50"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[Category]"
                      name="Category"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[SourceCode]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[SourceCode]"
                      length="50"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[SourceCode]"
                      name="SourceCode"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[BinLength]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[BinLength]"
                      length="10"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].Columns[BinLength]"
                      name="BinLength"
                      truncationRowDisposition="FailComponent" />
                  </outputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Category]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Category" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[SourceCode]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="SourceCode" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[BinLength]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="BinLength" />
                  </externalMetadataColumns>
                </output>
                <output
                  refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output]"
                  isErrorOut="true"
                  name="OLE DB Source Error Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Category]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Category]"
                      name="Category" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[SourceCode]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[SourceCode]"
                      name="SourceCode" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[BinLength]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[BinLength]"
                      name="BinLength" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
          </components>
          <paths>
            <path
              refId="Package\Data Flow Task.Paths[OLE DB Source Output]"
              endId="Package\Data Flow Task\OLE DB Destination.Inputs[OLE DB Destination Input]"
              name="OLE DB Source Output"
              startId="Package\Data Flow Task\OLE DB Source.Outputs[OLE DB Source Output]" />
          </paths>
        </pipeline>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Data Flow Task 1"
      DTS:CreationName="Microsoft.Pipeline"
      DTS:DelayValidation="True"
      DTS:Description="Data Flow Task"
      DTS:DTSID="{3E21A560-FD94-4F8A-A95E-9724E66C19FE}"
      DTS:ExecutableType="Microsoft.Pipeline"
      DTS:LocaleID="-1"
      DTS:ObjectName="Data Flow Task 1"
      DTS:TaskContact="Performs high-performance data extraction, transformation and loading;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1">
      <DTS:Variables />
      <DTS:ObjectData>
        <pipeline
          version="1">
          <components>
            <component
              refId="Package\Data Flow Task 1\OLE DB Destination"
              componentClassID="Microsoft.OLEDBDestination"
              contactInfo="OLE DB Destination;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;4"
              description="OLE DB Destination"
              name="OLE DB Destination"
              usesDispositions="true"
              version="4">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset">[rprt].[Dallas_VisitBySource]</property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor, Microsoft.DataTransformationServices.Controls, Version=15.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91"></property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">3</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the values supplied for identity columns will be copied to the destination. If false, values for identity columns will be auto-generated at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepIdentity">false</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the columns containing null will have null inserted in the destination. If false, columns containing null will have their default values inserted at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepNulls">false</property>
                <property
                  dataType="System.String"
                  description="Specifies options to be used with fast load.  Applies only if fast load is turned on."
                  name="FastLoadOptions">TABLOCK,CHECK_CONSTRAINTS</property>
                <property
                  dataType="System.Int32"
                  description="Specifies when commits are issued during data insertion.  A value of 0 specifies that one commit will be issued at the end of data insertion.  Applies only if fast load is turned on."
                  name="FastLoadMaxInsertCommitSize">2147483647</property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task 1\OLE DB Destination.Connections[OleDbConnection]"
                  connectionManagerID="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  connectionManagerRefId="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <inputs>
                <input
                  refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input]"
                  errorOrTruncationOperation="Insert"
                  errorRowDisposition="FailComponent"
                  hasSideEffects="true"
                  name="OLE DB Destination Input">
                  <inputColumns>
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Source Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="Source Code"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Source Code]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Source Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Member No]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="Member No"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Member No]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member No]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[CCard No]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="CCard No"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[CCard No]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[CCard No]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Title]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="Title"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Title]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Title]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[First Name]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="First Name"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[First Name]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[First Name]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Last Name]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="Last Name"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Last Name]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Last Name]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Membership Plan]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="Membership Plan"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Membership Plan]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Membership Plan]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Member Status]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="5"
                      cachedName="Member Status"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Member Status]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member Status]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Paid To Date]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="10"
                      cachedName="Paid To Date"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Paid To Date]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Paid To Date]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Experience Transaction Date]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="10"
                      cachedName="Experience Transaction Date"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Experience Transaction Date]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Experience Transaction Date]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Date Processed]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="10"
                      cachedName="Date Processed"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Date Processed]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Date Processed]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Guest Visits]"
                      cachedDataType="i4"
                      cachedName="Guest Visits"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Guest Visits]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Guest Visits]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Batch No]"
                      cachedDataType="r8"
                      cachedName="Batch No"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Batch No]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Batch No]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Reference]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Reference"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Reference]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Reference]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Lounge Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="Lounge Code"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge Code]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Lounge]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Lounge"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Airport]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Airport"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Airport]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Airport]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[City]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="City"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[City]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[City]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Country]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Country"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Country]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Country]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Pays Member Visit]"
                      cachedDataType="ui1"
                      cachedName="Client Pays Member Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Pays Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Member Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Inclusive PP Member Visit]"
                      cachedDataType="ui1"
                      cachedName="Inclusive PP Member Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Complimentary Member Visit]"
                      cachedDataType="ui1"
                      cachedName="Complimentary Member Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Pays Member Visit]"
                      cachedDataType="ui1"
                      cachedName="Cardholder Pays Member Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Pays Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Member Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Pays Guest Visit]"
                      cachedDataType="ui1"
                      cachedName="Client Pays Guest Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Pays Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Guest Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Inclusive PP Guest Visit]"
                      cachedDataType="ui1"
                      cachedName="Inclusive PP Guest Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Complimentary Guest Visit]"
                      cachedDataType="ui1"
                      cachedName="Complimentary Guest Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Guest Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Pays Guest Visit]"
                      cachedDataType="ui1"
                      cachedName="Cardholder Pays Guest Visit"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Pays Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Guest Visit]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Lounge Visit Offer]"
                      cachedDataType="ui1"
                      cachedName="Lounge Visit Offer"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge Visit Offer]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Visit Offer]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Member]"
                      cachedDataType="i4"
                      cachedName="Client Member"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Inclusive PP Member]"
                      cachedDataType="i4"
                      cachedName="Inclusive PP Member"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Guest]"
                      cachedDataType="i4"
                      cachedName="Client Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Inclusive PP Guest]"
                      cachedDataType="i4"
                      cachedName="Inclusive PP Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Member/Guest]"
                      cachedDataType="i4"
                      cachedName="Client Member/Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member/Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Inclusive PP Member/Guest]"
                      cachedDataType="i4"
                      cachedName="Inclusive PP Member/Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member/Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Complimentary Member/Guest]"
                      cachedDataType="i4"
                      cachedName="Complimentary Member/Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member/Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Visit Currency Member]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Client Visit Currency Member"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Currency Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Visit Amount Member]"
                      cachedDataType="numeric"
                      cachedName="Client Visit Amount Member"
                      cachedPrecision="10"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Amount Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Visit Currency Guest]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Client Visit Currency Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Currency Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Client Visit Amount Guest]"
                      cachedDataType="numeric"
                      cachedName="Client Visit Amount Guest"
                      cachedPrecision="10"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Amount Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Total Client Amount Currency]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Total Client Amount Currency"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Client Amount Currency]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount Currency]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Total Client Amount]"
                      cachedDataType="numeric"
                      cachedName="Total Client Amount"
                      cachedPrecision="19"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Client Amount]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Visit Currency Member]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Cardholder Visit Currency Member"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Currency Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Visit Amount Member]"
                      cachedDataType="numeric"
                      cachedName="Cardholder Visit Amount Member"
                      cachedPrecision="10"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Amount Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Member]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Visit Currency Guest]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Cardholder Visit Currency Guest"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Currency Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cardholder Visit Amount Guest]"
                      cachedDataType="numeric"
                      cachedName="Cardholder Visit Amount Guest"
                      cachedPrecision="10"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Amount Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Guest]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Total Cardholder Amount Currency]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="2"
                      cachedName="Total Cardholder Amount Currency"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Cardholder Amount Currency]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount Currency]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Total Cardholder Amount]"
                      cachedDataType="numeric"
                      cachedName="Total Cardholder Amount"
                      cachedPrecision="19"
                      cachedScale="2"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Cardholder Amount]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Cost Centre]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Cost Centre"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cost Centre]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cost Centre]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Campaign Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Campaign Code"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Campaign Code]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Campaign Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Vendor Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="Vendor Code"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Vendor Code]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Vendor Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[User Invitation Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="100"
                      cachedName="User Invitation Code"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[User Invitation Code]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[User Invitation Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[WSD Member No]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="20"
                      cachedName="WSD Member No"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[WSD Member NO]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[WSD Member No]" />
                  </inputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Report_Month]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Report_Month" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Source Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Member No]"
                      dataType="i8"
                      name="Member No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[CCard No]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="CCard No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Title]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Title" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[First Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="First Name" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Last Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Last Name" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Membership Plan]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Membership Plan" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Member Status]"
                      codePage="1252"
                      dataType="str"
                      length="5"
                      name="Member Status" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Paid To Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Paid To Date" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Experience Transaction Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Experience Transaction Date" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Date Processed]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Date Processed" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Guest Visits]"
                      dataType="i4"
                      name="Guest Visits" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Batch No]"
                      dataType="i4"
                      name="Batch No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Reference]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Reference" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Lounge Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Lounge" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Airport]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Airport" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[City]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="City" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Country]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Country" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Pays Member Visit]"
                      dataType="i4"
                      name="Client Pays Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member Visit]"
                      dataType="i4"
                      name="Inclusive PP Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Member Visit]"
                      dataType="i4"
                      name="Complimentary Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Pays Member Visit]"
                      dataType="i4"
                      name="Cardholder Pays Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Pays Guest Visit]"
                      dataType="i4"
                      name="Client Pays Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Guest Visit]"
                      dataType="i4"
                      name="Inclusive PP Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Guest Visit]"
                      dataType="i4"
                      name="Complimentary Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Pays Guest Visit]"
                      dataType="i4"
                      name="Cardholder Pays Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Lounge Visit Offer]"
                      dataType="i4"
                      name="Lounge Visit Offer" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Member]"
                      dataType="i4"
                      name="Client Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member]"
                      dataType="i4"
                      name="Inclusive PP Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Guest]"
                      dataType="i4"
                      name="Client Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Guest]"
                      dataType="i4"
                      name="Inclusive PP Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Member/Guest]"
                      dataType="i4"
                      name="Client Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Inclusive PP Member/Guest]"
                      dataType="i4"
                      name="Inclusive PP Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Complimentary Member/Guest]"
                      dataType="i4"
                      name="Complimentary Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Client Visit Currency Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Amount Member]"
                      dataType="r8"
                      name="Client Visit Amount Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Client Visit Currency Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Client Visit Amount Guest]"
                      dataType="r8"
                      name="Client Visit Amount Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Client Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Total Client Amount Currency" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Client Amount]"
                      dataType="r8"
                      name="Total Client Amount" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Cardholder Visit Currency Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Amount Member]"
                      dataType="r8"
                      name="Cardholder Visit Amount Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Cardholder Visit Currency Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cardholder Visit Amount Guest]"
                      dataType="r8"
                      name="Cardholder Visit Amount Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Cardholder Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Total Cardholder Amount Currency" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Total Cardholder Amount]"
                      dataType="r8"
                      name="Total Cardholder Amount" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Cost Centre]"
                      codePage="1252"
                      dataType="str"
                      length="300"
                      name="Cost Centre" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Campaign Code]"
                      codePage="1252"
                      dataType="str"
                      length="300"
                      name="Campaign Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Vendor Code]"
                      codePage="1252"
                      dataType="str"
                      length="300"
                      name="Vendor Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[User Invitation Code]"
                      codePage="1252"
                      dataType="str"
                      length="300"
                      name="User Invitation Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[WSD Member NO]"
                      dataType="i8"
                      name="WSD Member NO" />
                  </externalMetadataColumns>
                </input>
              </inputs>
              <outputs>
                <output
                  refId="Package\Data Flow Task 1\OLE DB Destination.Outputs[OLE DB Destination Error Output]"
                  exclusionGroup="1"
                  isErrorOut="true"
                  name="OLE DB Destination Error Output"
                  synchronousInputId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input]">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
            <component
              refId="Package\Data Flow Task 1\OLE DB Source"
              componentClassID="Microsoft.OLEDBSource"
              contactInfo="OLE DB Source;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;7"
              description="OLE DB Source"
              name="OLE DB Source"
              usesDispositions="true"
              version="7">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset"></property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor, Microsoft.DataTransformationServices.Controls, Version=15.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91">SELECT DISTINCT
       source_code AS [Source Code]
	   ,SUBSTRING(CAST(membership_no AS VARCHAR(20)),4,LEN(membership_no)-4) as [Member No]
	   ,CAST(membership_no AS VARCHAR(20)) as [WSD Member No]
		,temp.trans_ccard_number AS [CCard No]
	   ,title AS [Title]
	   ,forename AS [First Name]
	   ,surname AS [Last Name]
	   ,product_version AS [Membership Plan]
	   ,subs_status AS [Member Status]
	   ,convert(VARCHAR(10),paid_to_date,101) AS [Paid To Date]
	   ,convert(VARCHAR(10),track_start,101) AS [Experience Transaction Date]
	   ,convert(VARCHAR(10),creation_date,101) AS [Date Processed]
	   ,track_guests AS [Guest Visits]
	   ,track_value AS [Batch No]
	   ,external_ref AS [Reference]
	   ,lounge_code AS [Lounge Code]
	   ,lounge_name AS [Lounge]
	   ,airport AS [Airport]
	   ,city AS [City]
	   ,country AS [Country]
	   ,count_mem_cli AS [Client Pays Member Visit]
	   ,count_mem_pp AS [Inclusive PP Member Visit]
	   ,count_mem_comp AS [Complimentary Member Visit]
	   ,count_mem_mem AS [Cardholder Pays Member Visit]

	   ,count_gue_cli AS [Client Pays Guest Visit]
	   ,count_gue_pp AS [Inclusive PP Guest Visit]
	   ,count_gue_comp AS [Complimentary Guest Visit]
	   ,count_gue_mem AS [Cardholder Pays Guest Visit]
	   ,count_gue_lou AS [Lounge Visit Offer]
	   ,remaining_mem_cli_count AS [Client Member]
	   ,remaining_mem_pp_count AS [Inclusive PP Member]

	   ,remaining_gue_cli2_count AS [Client Guest]
	   ,remaining_gue_pp_count AS [Inclusive PP Guest]
	   ,remaining_mgu_cli_count AS [Client Member/Guest]
	   ,remaining_mgu_pp_count AS [Inclusive PP Member/Guest]
	   ,remaining_mgu_comp_count AS [Complimentary Member/Guest]
	   ,fee_mem_cli_curr AS [Client Visit Currency Member]
	   ,fee_mem_cli AS [Client Visit Amount Member]
	   ,fee_gue_cli_curr AS [Client Visit Currency Guest]
	   ,fee_gue_cli AS [Client Visit Amount Guest]
	   ,COALESCE(fee_mem_cli_curr,fee_gue_cli_curr) AS [Total Client Amount Currency]
	   ,CAST(fee_mem_cli AS NUMERIC(18,2))+ CAST(fee_gue_cli AS NUMERIC(18,2)) AS [Total Client Amount]
	   
	   ,fee_mem_mem_curr	 AS [Cardholder Visit Currency Member]
	   ,fee_mem_mem	 AS [Cardholder Visit Amount Member]
	   ,fee_gue_mem_curr AS [Cardholder Visit Currency Guest]
	   ,fee_gue_mem AS [Cardholder Visit Amount Guest]
	   
	   ,COALESCE(fee_mem_mem_curr,fee_gue_mem_curr) AS [Total Cardholder Amount Currency]
	   ,CAST(fee_mem_mem AS NUMERIC(18,2))+CAST(fee_gue_mem AS NUMERIC(18,2)) AS [Total Cardholder Amount]
	   
	   ,old_system_ref AS [Cost Centre]
	   ,campaign_code AS [Campaign Code]
	   ,vendor_tracking_code AS [Vendor Code]
	   ,user_invitation_code AS [User Invitation Code]
 FROM
	##temptable AS temp
	INNER JOIN PPass.dbo.purchase_visit_summary_data AS pvsd WITH (NOLOCK) ON temp.purchase_no = pvsd.purchase_no AND temp.track_seq = pvsd.track_seq</property>
                <property
                  dataType="System.String"
                  description="The variable that contains the SQL command to be executed."
                  name="SqlCommandVariable">User::strQuery</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">2</property>
                <property
                  dataType="System.String"
                  description="The mappings between the parameters in the SQL command and variables."
                  name="ParameterMapping"></property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task 1\OLE DB Source.Connections[OleDbConnection]"
                  connectionManagerID="Package.ConnectionManagers[PPass]"
                  connectionManagerRefId="Package.ConnectionManagers[PPass]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <outputs>
                <output
                  refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output]"
                  name="OLE DB Source Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Source Code]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Source Code]"
                      name="Source Code"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member No]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Member No]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member No]"
                      name="Member No"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[CCard No]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[CCard No]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[CCard No]"
                      name="CCard No"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Title]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Title]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Title]"
                      name="Title"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[First Name]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[First Name]"
                      length="50"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[First Name]"
                      name="First Name"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Last Name]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Last Name]"
                      length="50"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Last Name]"
                      name="Last Name"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Membership Plan]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Membership Plan]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Membership Plan]"
                      name="Membership Plan"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member Status]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Member Status]"
                      length="5"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Member Status]"
                      name="Member Status"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Paid To Date]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Paid To Date]"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Paid To Date]"
                      name="Paid To Date"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Experience Transaction Date]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Experience Transaction Date]"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Experience Transaction Date]"
                      name="Experience Transaction Date"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Date Processed]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Date Processed]"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Date Processed]"
                      name="Date Processed"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Guest Visits]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Guest Visits]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Guest Visits]"
                      name="Guest Visits"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Batch No]"
                      dataType="r8"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Batch No]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Batch No]"
                      name="Batch No"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Reference]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Reference]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Reference]"
                      name="Reference"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge Code]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Code]"
                      name="Lounge Code"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge]"
                      name="Lounge"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Airport]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Airport]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Airport]"
                      name="Airport"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[City]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[City]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[City]"
                      name="City"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Country]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Country]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Country]"
                      name="Country"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Member Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Pays Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Member Visit]"
                      name="Client Pays Member Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member Visit]"
                      name="Inclusive PP Member Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member Visit]"
                      name="Complimentary Member Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Member Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Pays Member Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Member Visit]"
                      name="Cardholder Pays Member Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Guest Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Pays Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Pays Guest Visit]"
                      name="Client Pays Guest Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest Visit]"
                      name="Inclusive PP Guest Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Guest Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Guest Visit]"
                      name="Complimentary Guest Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Guest Visit]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Pays Guest Visit]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Pays Guest Visit]"
                      name="Cardholder Pays Guest Visit"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Visit Offer]"
                      dataType="ui1"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge Visit Offer]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Lounge Visit Offer]"
                      name="Lounge Visit Offer"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member]"
                      name="Client Member"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member]"
                      name="Inclusive PP Member"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Guest]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Guest]"
                      name="Client Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Guest]"
                      name="Inclusive PP Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member/Guest]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Member/Guest]"
                      name="Client Member/Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member/Guest]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Inclusive PP Member/Guest]"
                      name="Inclusive PP Member/Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member/Guest]"
                      dataType="i4"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Member/Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Complimentary Member/Guest]"
                      name="Complimentary Member/Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Currency Member]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Member]"
                      name="Client Visit Currency Member"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Member]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Amount Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Member]"
                      name="Client Visit Amount Member"
                      precision="10"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Currency Guest]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Currency Guest]"
                      name="Client Visit Currency Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Guest]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Amount Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Client Visit Amount Guest]"
                      name="Client Visit Amount Guest"
                      precision="10"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Client Amount Currency]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount Currency]"
                      name="Total Client Amount Currency"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Client Amount]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Client Amount]"
                      name="Total Client Amount"
                      precision="19"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Currency Member]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Member]"
                      name="Cardholder Visit Currency Member"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Member]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Amount Member]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Member]"
                      name="Cardholder Visit Amount Member"
                      precision="10"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Currency Guest]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Currency Guest]"
                      name="Cardholder Visit Currency Guest"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Guest]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Amount Guest]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cardholder Visit Amount Guest]"
                      name="Cardholder Visit Amount Guest"
                      precision="10"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Cardholder Amount Currency]"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount Currency]"
                      name="Total Cardholder Amount Currency"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount]"
                      dataType="numeric"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Cardholder Amount]"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Total Cardholder Amount]"
                      name="Total Cardholder Amount"
                      precision="19"
                      scale="2"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cost Centre]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cost Centre]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Cost Centre]"
                      name="Cost Centre"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Campaign Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Campaign Code]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Campaign Code]"
                      name="Campaign Code"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Vendor Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Vendor Code]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[Vendor Code]"
                      name="Vendor Code"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[User Invitation Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[User Invitation Code]"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[User Invitation Code]"
                      name="User Invitation Code"
                      truncationRowDisposition="FailComponent" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[WSD Member No]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[WSD Member No]"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].Columns[WSD Member No]"
                      name="WSD Member No"
                      truncationRowDisposition="FailComponent" />
                  </outputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Source Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Member No]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Member No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[CCard No]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="CCard No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Title]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Title" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[First Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="First Name" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Last Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Last Name" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Membership Plan]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Membership Plan" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Member Status]"
                      codePage="1252"
                      dataType="str"
                      length="5"
                      name="Member Status" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Paid To Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Paid To Date" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Experience Transaction Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Experience Transaction Date" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Date Processed]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="Date Processed" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Guest Visits]"
                      dataType="i4"
                      name="Guest Visits" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Batch No]"
                      dataType="r8"
                      name="Batch No" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Reference]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Reference" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="Lounge Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Lounge" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Airport]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Airport" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[City]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="City" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Country]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Country" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Pays Member Visit]"
                      dataType="ui1"
                      name="Client Pays Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member Visit]"
                      dataType="ui1"
                      name="Inclusive PP Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Member Visit]"
                      dataType="ui1"
                      name="Complimentary Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Pays Member Visit]"
                      dataType="ui1"
                      name="Cardholder Pays Member Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Pays Guest Visit]"
                      dataType="ui1"
                      name="Client Pays Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Guest Visit]"
                      dataType="ui1"
                      name="Inclusive PP Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Guest Visit]"
                      dataType="ui1"
                      name="Complimentary Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Pays Guest Visit]"
                      dataType="ui1"
                      name="Cardholder Pays Guest Visit" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Lounge Visit Offer]"
                      dataType="ui1"
                      name="Lounge Visit Offer" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Member]"
                      dataType="i4"
                      name="Client Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member]"
                      dataType="i4"
                      name="Inclusive PP Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Guest]"
                      dataType="i4"
                      name="Client Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Guest]"
                      dataType="i4"
                      name="Inclusive PP Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Member/Guest]"
                      dataType="i4"
                      name="Client Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Inclusive PP Member/Guest]"
                      dataType="i4"
                      name="Inclusive PP Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Complimentary Member/Guest]"
                      dataType="i4"
                      name="Complimentary Member/Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Client Visit Currency Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Amount Member]"
                      dataType="numeric"
                      name="Client Visit Amount Member"
                      precision="10"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Client Visit Currency Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Client Visit Amount Guest]"
                      dataType="numeric"
                      name="Client Visit Amount Guest"
                      precision="10"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Client Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Total Client Amount Currency" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Client Amount]"
                      dataType="numeric"
                      name="Total Client Amount"
                      precision="19"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Cardholder Visit Currency Member" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Amount Member]"
                      dataType="numeric"
                      name="Cardholder Visit Amount Member"
                      precision="10"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Cardholder Visit Currency Guest" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cardholder Visit Amount Guest]"
                      dataType="numeric"
                      name="Cardholder Visit Amount Guest"
                      precision="10"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Cardholder Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      name="Total Cardholder Amount Currency" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Total Cardholder Amount]"
                      dataType="numeric"
                      name="Total Cardholder Amount"
                      precision="19"
                      scale="2" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Cost Centre]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Cost Centre" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Campaign Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Campaign Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[Vendor Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="Vendor Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[User Invitation Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      name="User Invitation Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output].ExternalColumns[WSD Member No]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      name="WSD Member No" />
                  </externalMetadataColumns>
                </output>
                <output
                  refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output]"
                  isErrorOut="true"
                  name="OLE DB Source Error Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Source Code]"
                      name="Source Code" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Member No]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Member No]"
                      name="Member No" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[WSD Member No]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[WSD Member No]"
                      name="WSD Member No" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[CCard No]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[CCard No]"
                      name="CCard No" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Title]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Title]"
                      name="Title" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[First Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[First Name]"
                      name="First Name" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Last Name]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Last Name]"
                      name="Last Name" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Membership Plan]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Membership Plan]"
                      name="Membership Plan" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Member Status]"
                      codePage="1252"
                      dataType="str"
                      length="5"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Member Status]"
                      name="Member Status" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Paid To Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Paid To Date]"
                      name="Paid To Date" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Experience Transaction Date]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Experience Transaction Date]"
                      name="Experience Transaction Date" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Date Processed]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Date Processed]"
                      name="Date Processed" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Guest Visits]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Guest Visits]"
                      name="Guest Visits" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Batch No]"
                      dataType="r8"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Batch No]"
                      name="Batch No" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Reference]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Reference]"
                      name="Reference" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge Code]"
                      codePage="1252"
                      dataType="str"
                      length="20"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge Code]"
                      name="Lounge Code" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge]"
                      name="Lounge" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Airport]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Airport]"
                      name="Airport" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[City]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[City]"
                      name="City" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Country]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Country]"
                      name="Country" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Pays Member Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Pays Member Visit]"
                      name="Client Pays Member Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member Visit]"
                      name="Inclusive PP Member Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Member Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Member Visit]"
                      name="Complimentary Member Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Pays Member Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Pays Member Visit]"
                      name="Cardholder Pays Member Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Pays Guest Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Pays Guest Visit]"
                      name="Client Pays Guest Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Guest Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Guest Visit]"
                      name="Inclusive PP Guest Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Guest Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Guest Visit]"
                      name="Complimentary Guest Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Pays Guest Visit]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Pays Guest Visit]"
                      name="Cardholder Pays Guest Visit" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge Visit Offer]"
                      dataType="ui1"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Lounge Visit Offer]"
                      name="Lounge Visit Offer" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Member]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Member]"
                      name="Client Member" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member]"
                      name="Inclusive PP Member" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Guest]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Guest]"
                      name="Client Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Guest]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Guest]"
                      name="Inclusive PP Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Member/Guest]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Member/Guest]"
                      name="Client Member/Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member/Guest]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Inclusive PP Member/Guest]"
                      name="Inclusive PP Member/Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Member/Guest]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Complimentary Member/Guest]"
                      name="Complimentary Member/Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Currency Member]"
                      name="Client Visit Currency Member" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Amount Member]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Amount Member]"
                      name="Client Visit Amount Member"
                      precision="10"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Currency Guest]"
                      name="Client Visit Currency Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Amount Guest]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Client Visit Amount Guest]"
                      name="Client Visit Amount Guest"
                      precision="10"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Client Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Client Amount Currency]"
                      name="Total Client Amount Currency" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Client Amount]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Client Amount]"
                      name="Total Client Amount"
                      precision="19"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Currency Member]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Currency Member]"
                      name="Cardholder Visit Currency Member" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Amount Member]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Amount Member]"
                      name="Cardholder Visit Amount Member"
                      precision="10"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Currency Guest]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Currency Guest]"
                      name="Cardholder Visit Currency Guest" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Amount Guest]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cardholder Visit Amount Guest]"
                      name="Cardholder Visit Amount Guest"
                      precision="10"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Cardholder Amount Currency]"
                      codePage="1252"
                      dataType="str"
                      length="2"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Cardholder Amount Currency]"
                      name="Total Cardholder Amount Currency" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Cardholder Amount]"
                      dataType="numeric"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Total Cardholder Amount]"
                      name="Total Cardholder Amount"
                      precision="19"
                      scale="2" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cost Centre]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Cost Centre]"
                      name="Cost Centre" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Campaign Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Campaign Code]"
                      name="Campaign Code" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Vendor Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[Vendor Code]"
                      name="Vendor Code" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[User Invitation Code]"
                      codePage="1252"
                      dataType="str"
                      length="100"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[User Invitation Code]"
                      name="User Invitation Code" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
          </components>
          <paths>
            <path
              refId="Package\Data Flow Task 1.Paths[OLE DB Source Output]"
              endId="Package\Data Flow Task 1\OLE DB Destination.Inputs[OLE DB Destination Input]"
              name="OLE DB Source Output"
              startId="Package\Data Flow Task 1\OLE DB Source.Outputs[OLE DB Source Output]" />
          </paths>
        </pipeline>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Data Flow Task 2"
      DTS:CreationName="Microsoft.Pipeline"
      DTS:Description="Data Flow Task"
      DTS:DTSID="{FD742618-9169-4A39-A1D1-C27A389118A5}"
      DTS:ExecutableType="Microsoft.Pipeline"
      DTS:LocaleID="-1"
      DTS:ObjectName="Data Flow Task 2"
      DTS:TaskContact="Performs high-performance data extraction, transformation and loading;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved;http://www.microsoft.com/sql/support/default.asp;1">
      <DTS:Variables />
      <DTS:ObjectData>
        <pipeline
          version="1">
          <components>
            <component
              refId="Package\Data Flow Task 2\Data Conversion"
              componentClassID="Microsoft.DataConvert"
              contactInfo="Data Conversion;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;0"
              description="Data Conversion"
              name="Data Conversion"
              usesDispositions="true">
              <inputs>
                <input
                  refId="Package\Data Flow Task 2\Data Conversion.Inputs[Data Conversion Input]"
                  name="Data Conversion Input">
                  <externalMetadataColumns />
                </input>
              </inputs>
              <outputs>
                <output
                  refId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Output]"
                  exclusionGroup="1"
                  name="Data Conversion Output"
                  synchronousInputId="Package\Data Flow Task 2\Data Conversion.Inputs[Data Conversion Input]">
                  <externalMetadataColumns />
                </output>
                <output
                  refId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Error Output]"
                  exclusionGroup="1"
                  isErrorOut="true"
                  name="Data Conversion Error Output"
                  synchronousInputId="Package\Data Flow Task 2\Data Conversion.Inputs[Data Conversion Input]">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
            <component
              refId="Package\Data Flow Task 2\Flat File Source"
              componentClassID="Microsoft.FlatFileSource"
              contactInfo="Flat File Source;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;1"
              description="Flat File Source"
              localeId="2057"
              name="Flat File Source"
              usesDispositions="true"
              version="1">
              <properties>
                <property
                  dataType="System.Boolean"
                  description="Specifies whether zero-length columns are treated as null."
                  name="RetainNulls">false</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of an output column containing the file name. If no name is specified, no output column containing the file name will be generated."
                  name="FileNameColumnName"></property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task 2\Flat File Source.Connections[FlatFileConnection]"
                  connectionManagerID="Package.ConnectionManagers[Flat File Connection Manager]"
                  connectionManagerRefId="Package.ConnectionManagers[Flat File Connection Manager]"
                  name="FlatFileConnection" />
              </connections>
              <outputs>
                <output
                  refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output]"
                  name="Flat File Source Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Type]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Type]"
                      length="50"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Type]"
                      name="Type"
                      truncationRowDisposition="FailComponent">
                      <properties>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the column uses the faster, locale-neutral parsing routines."
                          name="FastParse">false</property>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the data is in binary format."
                          name="UseBinaryFormat">false</property>
                      </properties>
                    </outputColumn>
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Source Code]"
                      length="50"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Source Code]"
                      name="Source Code"
                      truncationRowDisposition="FailComponent">
                      <properties>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the column uses the faster, locale-neutral parsing routines."
                          name="FastParse">false</property>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the data is in binary format."
                          name="UseBinaryFormat">false</property>
                      </properties>
                    </outputColumn>
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Bin Length]"
                      codePage="1252"
                      dataType="str"
                      errorOrTruncationOperation="Conversion"
                      errorRowDisposition="FailComponent"
                      externalMetadataColumnId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Bin Length]"
                      length="50"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Bin Length]"
                      name="Bin Length"
                      truncationRowDisposition="FailComponent">
                      <properties>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the column uses the faster, locale-neutral parsing routines."
                          name="FastParse">false</property>
                        <property
                          dataType="System.Boolean"
                          description="Indicates whether the data is in binary format."
                          name="UseBinaryFormat">false</property>
                      </properties>
                    </outputColumn>
                  </outputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Type]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Type" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Source Code]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Source Code" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].ExternalColumns[Bin Length]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Bin Length" />
                  </externalMetadataColumns>
                </output>
                <output
                  refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output]"
                  isErrorOut="true"
                  name="Flat File Source Error Output">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[Flat File Source Error Output Column]"
                      codePage="1252"
                      dataType="text"
                      description="Flat File Source Error Output Column"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[Flat File Source Error Output Column]"
                      name="Flat File Source Error Output Column" />
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
            <component
              refId="Package\Data Flow Task 2\OLE DB Destination"
              componentClassID="Microsoft.OLEDBDestination"
              contactInfo="OLE DB Destination;Microsoft Corporation; Microsoft SQL Server; (C) Microsoft Corporation; All Rights Reserved; http://www.microsoft.com/sql/support;4"
              description="OLE DB Destination"
              name="OLE DB Destination"
              usesDispositions="true"
              version="4">
              <properties>
                <property
                  dataType="System.Int32"
                  description="The number of seconds before a command times out.  A value of 0 indicates an infinite time-out."
                  name="CommandTimeout">0</property>
                <property
                  dataType="System.String"
                  description="Specifies the name of the database object used to open a rowset."
                  name="OpenRowset">[rprt].[Dallas_SourceCodeList]</property>
                <property
                  dataType="System.String"
                  description="Specifies the variable that contains the name of the database object used to open a rowset."
                  name="OpenRowsetVariable"></property>
                <property
                  dataType="System.String"
                  description="The SQL command to be executed."
                  name="SqlCommand"
                  UITypeEditor="Microsoft.DataTransformationServices.Controls.ModalMultilineStringEditor, Microsoft.DataTransformationServices.Controls, Version=15.0.0.0, Culture=neutral, PublicKeyToken=89845dcd8080cc91"></property>
                <property
                  dataType="System.Int32"
                  description="Specifies the column code page to use when code page information is unavailable from the data source."
                  name="DefaultCodePage">1252</property>
                <property
                  dataType="System.Boolean"
                  description="Forces the use of the DefaultCodePage property value when describing character data."
                  name="AlwaysUseDefaultCodePage">false</property>
                <property
                  dataType="System.Int32"
                  description="Specifies the mode used to access the database."
                  name="AccessMode"
                  typeConverter="AccessMode">3</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the values supplied for identity columns will be copied to the destination. If false, values for identity columns will be auto-generated at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepIdentity">false</property>
                <property
                  dataType="System.Boolean"
                  description="Indicates whether the columns containing null will have null inserted in the destination. If false, columns containing null will have their default values inserted at the destination. Applies only if fast load is turned on."
                  name="FastLoadKeepNulls">false</property>
                <property
                  dataType="System.String"
                  description="Specifies options to be used with fast load.  Applies only if fast load is turned on."
                  name="FastLoadOptions">TABLOCK,CHECK_CONSTRAINTS</property>
                <property
                  dataType="System.Int32"
                  description="Specifies when commits are issued during data insertion.  A value of 0 specifies that one commit will be issued at the end of data insertion.  Applies only if fast load is turned on."
                  name="FastLoadMaxInsertCommitSize">2147483647</property>
              </properties>
              <connections>
                <connection
                  refId="Package\Data Flow Task 2\OLE DB Destination.Connections[OleDbConnection]"
                  connectionManagerID="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  connectionManagerRefId="Package.ConnectionManagers[DI-BILLING.OpsBilling]"
                  description="The OLE DB runtime connection used to access the database."
                  name="OleDbConnection" />
              </connections>
              <inputs>
                <input
                  refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input]"
                  errorOrTruncationOperation="Insert"
                  errorRowDisposition="FailComponent"
                  hasSideEffects="true"
                  name="OLE DB Destination Input">
                  <inputColumns>
                    <inputColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Type]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="Type"
                      externalMetadataColumnId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Category]"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Type]" />
                    <inputColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Source Code]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="Source Code"
                      externalMetadataColumnId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[SourceCode]"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Source Code]" />
                    <inputColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].Columns[Bin Length]"
                      cachedCodepage="1252"
                      cachedDataType="str"
                      cachedLength="50"
                      cachedName="Bin Length"
                      externalMetadataColumnId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[BinLength]"
                      lineageId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output].Columns[Bin Length]" />
                  </inputColumns>
                  <externalMetadataColumns
                    isUsed="True">
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[Category]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="Category" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[SourceCode]"
                      codePage="1252"
                      dataType="str"
                      length="50"
                      name="SourceCode" />
                    <externalMetadataColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input].ExternalColumns[BinLength]"
                      codePage="1252"
                      dataType="str"
                      length="10"
                      name="BinLength" />
                  </externalMetadataColumns>
                </input>
              </inputs>
              <outputs>
                <output
                  refId="Package\Data Flow Task 2\OLE DB Destination.Outputs[OLE DB Destination Error Output]"
                  exclusionGroup="1"
                  isErrorOut="true"
                  name="OLE DB Destination Error Output"
                  synchronousInputId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input]">
                  <outputColumns>
                    <outputColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorCode]"
                      name="ErrorCode"
                      specialFlags="1" />
                    <outputColumn
                      refId="Package\Data Flow Task 2\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      dataType="i4"
                      lineageId="Package\Data Flow Task 2\OLE DB Destination.Outputs[OLE DB Destination Error Output].Columns[ErrorColumn]"
                      name="ErrorColumn"
                      specialFlags="2" />
                  </outputColumns>
                  <externalMetadataColumns />
                </output>
              </outputs>
            </component>
          </components>
          <paths>
            <path
              refId="Package\Data Flow Task 2.Paths[Data Conversion Output]"
              endId="Package\Data Flow Task 2\OLE DB Destination.Inputs[OLE DB Destination Input]"
              name="Data Conversion Output"
              startId="Package\Data Flow Task 2\Data Conversion.Outputs[Data Conversion Output]" />
            <path
              refId="Package\Data Flow Task 2.Paths[Flat File Source Output]"
              endId="Package\Data Flow Task 2\Data Conversion.Inputs[Data Conversion Input]"
              name="Flat File Source Output"
              startId="Package\Data Flow Task 2\Flat File Source.Outputs[Flat File Source Output]" />
          </paths>
        </pipeline>
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\EST_CreateTableinTempdb"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:DelayValidation="True"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{1A90FE06-8642-441D-B3FA-58473A41616A}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="EST_CreateTableinTempdb"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{DE205D8A-DF9F-410E-A52B-2F655746C1BF}"
          SQLTask:SqlStatementSource="IF OBJECT_ID(N'tempdb..##VisitBySourceSourceCodes') IS NOT NULL&#xA;BEGIN&#xA;DROP TABLE ##VisitBySourceSourceCodes&#xA;END&#xA;GO&#xA;CREATE TABLE ##VisitBySourceSourceCodes(Category VARCHAR(50),SourceCode VARCHAR(50),BinLength VARCHAR(10))" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Execute SQL Task"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:DelayValidation="True"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{3E38A8AC-F66E-4EDD-8779-49A3363CA34A}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Execute SQL Task"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{DE205D8A-DF9F-410E-A52B-2F655746C1BF}"
          SQLTask:SqlStmtSourceType="Variable"
          SQLTask:SqlStatementSource="User::strQuery" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Execute SQL Task 1"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{F5C8C567-0159-4582-BF41-97F74D6C0BFA}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Execute SQL Task 1"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{394A1823-FD15-487A-91A2-F3EF3B7817BB}"
          SQLTask:SqlStatementSource="TRUNCATE TABLE rprt.Dallas_VisitBySource" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
    <DTS:Executable
      DTS:refId="Package\Execute SQL Task 2"
      DTS:CreationName="Microsoft.ExecuteSQLTask"
      DTS:Description="Execute SQL Task"
      DTS:DTSID="{3799529D-B4E4-4823-B86B-8F5E986AE318}"
      DTS:ExecutableType="Microsoft.ExecuteSQLTask"
      DTS:LocaleID="-1"
      DTS:ObjectName="Execute SQL Task 2"
      DTS:ThreadHint="0">
      <DTS:Variables />
      <DTS:ObjectData>
        <SQLTask:SqlTaskData
          SQLTask:Connection="{394A1823-FD15-487A-91A2-F3EF3B7817BB}"
          SQLTask:SqlStatementSource="TRUNCATE TABLE rprt.Dallas_SourceCodeList" xmlns:SQLTask="www.microsoft.com/sqlserver/dts/tasks/sqltask" />
      </DTS:ObjectData>
    </DTS:Executable>
  </DTS:Executables>
  <DTS:PrecedenceConstraints>
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint]"
      DTS:CreationName=""
      DTS:DTSID="{77FF789B-8799-4FB5-9712-F0BA7561D99B}"
      DTS:From="Package\EST_CreateTableinTempdb"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint"
      DTS:To="Package\Data Flow Task" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 1]"
      DTS:CreationName=""
      DTS:DTSID="{F48F7F2C-E2F3-4BBF-89DA-5AC009FBCBD5}"
      DTS:From="Package\Data Flow Task"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 1"
      DTS:To="Package\Execute SQL Task" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 2]"
      DTS:CreationName=""
      DTS:DTSID="{9F1C3373-F0B3-4B36-BCBE-F5B61A2BBF7E}"
      DTS:From="Package\Execute SQL Task"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 2"
      DTS:To="Package\Data Flow Task 1" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 3]"
      DTS:CreationName=""
      DTS:DTSID="{F691B4CB-E031-4424-B862-19BF2A6BD92F}"
      DTS:From="Package\Execute SQL Task 1"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 3"
      DTS:To="Package\EST_CreateTableinTempdb" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 4]"
      DTS:CreationName=""
      DTS:DTSID="{483CDC64-63E8-490D-A410-EDF3A0086352}"
      DTS:From="Package\Data Flow Task 2"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 4"
      DTS:To="Package\Execute SQL Task 1" />
    <DTS:PrecedenceConstraint
      DTS:refId="Package.PrecedenceConstraints[Constraint 5]"
      DTS:CreationName=""
      DTS:DTSID="{FA4F60AC-004C-405B-A602-218D7E388D94}"
      DTS:From="Package\Execute SQL Task 2"
      DTS:LogicalAnd="True"
      DTS:ObjectName="Constraint 5"
      DTS:To="Package\Data Flow Task 2" />
  </DTS:PrecedenceConstraints>
  <DTS:DesignTimeProperties><![CDATA[<?xml version="1.0"?>
<!--This CDATA section contains the layout information of the package. The section includes information such as (x,y) coordinates, width, and height.-->
<!--If you manually edit this section and make a mistake, you can delete it. -->
<!--The package will still be able to load normally but the previous layout information will be lost and the designer will automatically re-arrange the elements on the design surface.-->
<Objects
  Version="8">
  <!--Each node below will contain properties that do not affect runtime behavior.-->
  <Package
    design-time-name="Package">
    <LayoutInfo>
      <GraphLayout
        Capacity="16" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="151,42"
          Id="Package\Data Flow Task"
          TopLeft="367,332" />
        <NodeLayout
          Size="160,42"
          Id="Package\Data Flow Task 1"
          TopLeft="368,533" />
        <NodeLayout
          Size="160,42"
          Id="Package\Data Flow Task 2"
          TopLeft="353,91" />
        <NodeLayout
          Size="206,42"
          Id="Package\EST_CreateTableinTempdb"
          TopLeft="339,246" />
        <NodeLayout
          Size="163,42"
          Id="Package\Execute SQL Task"
          TopLeft="366,437" />
        <NodeLayout
          Size="172,42"
          Id="Package\Execute SQL Task 1"
          TopLeft="355,174" />
        <NodeLayout
          Size="172,42"
          Id="Package\Execute SQL Task 2"
          TopLeft="339,21" />
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint]"
          TopLeft="442.25,288">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,44"
              Start="0,0"
              End="0,36.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,36.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 1]"
          TopLeft="445,374">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,63"
              Start="0,0"
              End="0,55.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,55.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 2]"
          TopLeft="447.75,479">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,54"
              Start="0,0"
              End="0,46.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,46.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 3]"
          TopLeft="441.5,216">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,30"
              Start="0,0"
              End="0,22.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,22.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 4]"
          TopLeft="433,133">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="8,41"
              Start="0,0"
              End="8,33.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,16.5" />
                  <mssgle:CubicBezierSegment
                    Point1="0,16.5"
                    Point2="0,20.5"
                    Point3="4,20.5" />
                  <mssgle:LineSegment
                    End="4,20.5" />
                  <mssgle:CubicBezierSegment
                    Point1="4,20.5"
                    Point2="8,20.5"
                    Point3="8,24.5" />
                  <mssgle:LineSegment
                    End="8,33.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package.PrecedenceConstraints[Constraint 5]"
          TopLeft="425,63">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="8,28"
              Start="0,0"
              End="8,20.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,10" />
                  <mssgle:CubicBezierSegment
                    Point1="0,10"
                    Point2="0,14"
                    Point3="4,14" />
                  <mssgle:LineSegment
                    End="4,14" />
                  <mssgle:CubicBezierSegment
                    Point1="4,14"
                    Point2="8,14"
                    Point3="8,18" />
                  <mssgle:LineSegment
                    End="8,20.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </Package>
  <TaskHost
    design-time-name="Package\Data Flow Task">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="150,42"
          Id="Package\Data Flow Task\OLE DB Source"
          TopLeft="495,90" />
        <NodeLayout
          Size="171,42"
          Id="Package\Data Flow Task\OLE DB Destination"
          TopLeft="493,175" />
        <EdgeLayout
          Id="Package\Data Flow Task.Paths[OLE DB Source Output]"
          TopLeft="570,132">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="8.5,43"
              Start="0,0"
              End="8.5,35.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,17.5" />
                  <mssgle:CubicBezierSegment
                    Point1="0,17.5"
                    Point2="0,21.5"
                    Point3="4,21.5" />
                  <mssgle:LineSegment
                    End="4.5,21.5" />
                  <mssgle:CubicBezierSegment
                    Point1="4.5,21.5"
                    Point2="8.5,21.5"
                    Point3="8.5,25.5" />
                  <mssgle:LineSegment
                    End="8.5,35.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </TaskHost>
  <PipelineComponentMetadata
    design-time-name="Package\Data Flow Task\OLE DB Destination">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
      <Property>
        <Name>TableInfoObjectType</Name>
        <Value
          type="q2:string">Table</Value>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
  <PipelineComponentMetadata
    design-time-name="Package\Data Flow Task\OLE DB Source">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
  <TaskHost
    design-time-name="Package\Data Flow Task 1">
    <LayoutInfo>
      <GraphLayout
        Capacity="4" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="150,42"
          Id="Package\Data Flow Task 1\OLE DB Source"
          TopLeft="344,63" />
        <NodeLayout
          Size="171,42"
          Id="Package\Data Flow Task 1\OLE DB Destination"
          TopLeft="332,157" />
        <EdgeLayout
          Id="Package\Data Flow Task 1.Paths[OLE DB Source Output]"
          TopLeft="418.25,105">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,52"
              Start="0,0"
              End="0,44.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,44.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </TaskHost>
  <PipelineComponentMetadata
    design-time-name="Package\Data Flow Task 1\OLE DB Destination">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
      <Property>
        <Name>TableInfoObjectType</Name>
        <Value
          type="q2:string">Table</Value>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
  <PipelineComponentMetadata
    design-time-name="Package\Data Flow Task 1\OLE DB Source">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
  <TaskHost
    design-time-name="Package\Data Flow Task 2">
    <LayoutInfo>
      <GraphLayout
        Capacity="8" xmlns="clr-namespace:Microsoft.SqlServer.IntegrationServices.Designer.Model.Serialization;assembly=Microsoft.SqlServer.IntegrationServices.Graph" xmlns:mssgle="clr-namespace:Microsoft.SqlServer.Graph.LayoutEngine;assembly=Microsoft.SqlServer.Graph" xmlns:assembly="http://schemas.microsoft.com/winfx/2006/xaml">
        <NodeLayout
          Size="171,42"
          Id="Package\Data Flow Task 2\OLE DB Destination"
          TopLeft="333,234" />
        <NodeLayout
          Size="156,42"
          Id="Package\Data Flow Task 2\Data Conversion"
          TopLeft="334,155" />
        <NodeLayout
          Size="151,42"
          Id="Package\Data Flow Task 2\Flat File Source"
          TopLeft="334,68" />
        <EdgeLayout
          Id="Package\Data Flow Task 2.Paths[Flat File Source Output]"
          TopLeft="410.75,110">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,45"
              Start="0,0"
              End="0,37.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,37.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
        <EdgeLayout
          Id="Package\Data Flow Task 2.Paths[Data Conversion Output]"
          TopLeft="415.25,197">
          <EdgeLayout.Curve>
            <mssgle:Curve
              StartConnector="{assembly:Null}"
              EndConnector="0,37"
              Start="0,0"
              End="0,29.5">
              <mssgle:Curve.Segments>
                <mssgle:SegmentCollection
                  Capacity="5">
                  <mssgle:LineSegment
                    End="0,29.5" />
                </mssgle:SegmentCollection>
              </mssgle:Curve.Segments>
            </mssgle:Curve>
          </EdgeLayout.Curve>
          <EdgeLayout.Labels>
            <EdgeLabelCollection />
          </EdgeLayout.Labels>
        </EdgeLayout>
      </GraphLayout>
    </LayoutInfo>
  </TaskHost>
  <PipelineComponentMetadata
    design-time-name="Package\Data Flow Task 2\OLE DB Destination">
    <Properties>
      <Property>
        <Name>DataSourceViewID</Name>
      </Property>
      <Property>
        <Name>TableInfoObjectType</Name>
        <Value
          type="q2:string">Table</Value>
      </Property>
    </Properties>
  </PipelineComponentMetadata>
</Objects>]]></DTS:DesignTimeProperties>
</DTS:Executable>